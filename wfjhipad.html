<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校園平板車租借系統</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", "Noto Sans TC", sans-serif; background-color: #f3f4f6; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #bbb; }
        
        /* Matrix Cell */
        .matrix-cell input:checked + div { background-color: #eff6ff; border-color: #3b82f6; color: #1d4ed8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, deleteDoc, doc, updateDoc, setDoc, serverTimestamp, writeBatch, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Init ---
        // 使用真實金鑰
        const firebaseConfig = {
          apiKey: "AIzaSyBAhA7PnvzJYT_Lil1iX-TVIEgtd9rBVHg",
          authDomain: "wfjh-87c3c.firebaseapp.com",
          projectId: "wfjh-87c3c",
          storageBucket: "wfjh-87c3c.firebasestorage.app",
          messagingSenderId: "884700920300",
          appId: "1:884700920300:web:a21314106a0c7b1d67e8c9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // 固定 ID
        const appId = 'wfjh-tablet-system';
        const ADMIN_EMAIL = 'zaia3787@gmail.com'; 

        // --- Initial Data ---
        const INITIAL_CARTS = [
            { id: 'A', location: '電腦教室 二', total: 36, enableOneTime: true, enableLongTerm: true },
            { id: 'B', location: '教具室216', total: 36, enableOneTime: true, enableLongTerm: true },
            { id: 'C', location: '教具室218', total: 36, enableOneTime: true, enableLongTerm: true },
            { id: 'D', location: '教具室316', total: 36, enableOneTime: true, enableLongTerm: true },
            { id: 'E', location: '教具室318', total: 36, enableOneTime: true, enableLongTerm: true },
            { id: 'F', location: '教具室312', total: 36, enableOneTime: true, enableLongTerm: true },
            { id: 'G', location: '教具室328', total: 36, enableOneTime: true, enableLongTerm: true },
            { id: 'H', location: '307', total: 36, enableOneTime: true, enableLongTerm: true },
            { id: 'I', location: '312', total: 36, enableOneTime: true, enableLongTerm: true },
            { id: 'J', location: '327', total: 36, enableOneTime: true, enableLongTerm: true },
            { id: 'K', location: '414', total: 36, enableOneTime: true, enableLongTerm: true },
            { id: 'L', location: '418', total: 36, enableOneTime: true, enableLongTerm: true },
            { id: 'M', location: '407', total: 36, enableOneTime: true, enableLongTerm: true },
            { id: 'N', location: '427', total: 36, enableOneTime: true, enableLongTerm: true },
        ];
        const PERIODS = [1, 2, 3, 4, 5, 6, 7];
        const DAYS_OF_WEEK = [1, 2, 3, 4, 5]; // Mon to Fri
        const DAY_LABELS = ['日', '一', '二', '三', '四', '五', '六'];
        const ALL_DEVICES = Array.from({length: 36}, (_, i) => i + 1);

        // --- Utility Functions ---
        const getDayOfWeek = (dateStr) => new Date(dateStr).getDay();
        const formatDate = (date) => {
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1);
            let day = '' + d.getDate();
            const year = d.getFullYear();
            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;
            return [year, month, day].join('-');
        };
        const getMinDate = () => {
            const d = new Date();
            d.setDate(d.getDate() + 2);
            return formatDate(d);
        };
        const addDays = (dateStr, days) => {
            const d = new Date(dateStr);
            d.setDate(d.getDate() + days);
            return formatDate(d);
        };

        const formatDeviceList = (ids) => {
            if (!ids || ids.length === 0) return "未分配";
            const sorted = [...ids].sort((a,b)=>a-b);
            const ranges = [];
            let rangeStart = sorted[0];
            let prev = sorted[0];
            for (let i = 1; i < sorted.length; i++) {
                if (sorted[i] === prev + 1) {
                    prev = sorted[i];
                } else {
                    ranges.push(rangeStart === prev ? `No.${rangeStart}` : `No.${rangeStart}~${prev}`);
                    rangeStart = sorted[i];
                    prev = sorted[i];
                }
            }
            ranges.push(rangeStart === prev ? `No.${rangeStart}` : `No.${rangeStart}~${prev}`);
            return ranges.join('、');
        };

        const sendEmailNotification = async (data) => {
            try {
                const payload = {
                    _subject: `[平板預約] ${data.user} - ${data.type === 'long-term' ? '長期' : '單次'}`,
                    _template: "table",
                    _captcha: "false",
                    ...data
                };
                await fetch(`https://formsubmit.co/ajax/${ADMIN_EMAIL}`, {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(payload)
                });
            } catch (error) { console.error("Email error:", error); }
        };

        // --- UI Components ---
        function Toast({ message, type, onClose }) {
            React.useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);
            const bgClass = type === 'error' ? 'bg-red-500' : 'bg-green-600';
            return (
                <div className={`fixed bottom-4 right-4 ${bgClass} text-white px-6 py-3 rounded-lg shadow-xl z-50 animate-slide-up flex items-center gap-2`}>
                    {type === 'error' ? <i data-lucide="alert-circle" className="w-5 h-5"></i> : <i data-lucide="check-circle" className="w-5 h-5"></i>}
                    <span className="font-medium">{message}</span>
                </div>
            );
        }

        function Modal({ isOpen, title, children, onClose }) {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-fade-in">
                    <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full overflow-hidden max-h-[90vh] flex flex-col">
                        <div className="bg-gray-100 px-4 py-3 border-b flex justify-between items-center flex-shrink-0">
                            <h3 className="font-bold text-gray-800">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><i data-lucide="x" className="w-5 h-5"></i></button>
                        </div>
                        <div className="p-4 overflow-y-auto flex-grow">{children}</div>
                    </div>
                </div>
            );
        }

        // --- Main App ---
        function App() {
            const [user, setUser] = React.useState(null);
            const [view, setView] = React.useState('frontend');
            const [carts, setCarts] = React.useState([]);
            const [bookings, setBookings] = React.useState([]);
            const [cartStatus, setCartStatus] = React.useState({});
            const [isAdmin, setIsAdmin] = React.useState(false);
            const seededRef = React.useRef(false);
            
            // Welcome Popup State
            const [showWelcome, setShowWelcome] = React.useState(true);

            const [toast, setToast] = React.useState(null); 
            const [modalConfig, setModalConfig] = React.useState(null); 

            const showToast = (message, type = 'success') => setToast({ message, type });
            const closeToast = () => setToast(null);

            React.useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            React.useEffect(() => {
                if (!user) return;
                const qCarts = query(collection(db, 'artifacts', appId, 'public', 'data', 'carts'));
                const unsubCarts = onSnapshot(qCarts, async (snap) => {
                    if (snap.empty && !seededRef.current) {
                        seededRef.current = true;
                        const checkSnap = await getDocs(qCarts);
                        if (checkSnap.empty) {
                            const batch = writeBatch(db);
                            INITIAL_CARTS.forEach(c => {
                                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'carts', c.id);
                                batch.set(docRef, c);
                            });
                            await batch.commit();
                        }
                    } else {
                        const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        list.sort((a, b) => a.id.localeCompare(b.id));
                        setCarts(list);
                    }
                });
                const qBookings = query(collection(db, 'artifacts', appId, 'public', 'data', 'bookings'));
                const unsubBookings = onSnapshot(qBookings, (snap) => setBookings(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                const qStatus = query(collection(db, 'artifacts', appId, 'public', 'data', 'cart_status'));
                const unsubStatus = onSnapshot(qStatus, (snap) => {
                    const statusMap = {};
                    snap.docs.forEach(d => statusMap[d.id] = d.data());
                    setCartStatus(statusMap);
                });
                return () => { unsubCarts(); unsubBookings(); unsubStatus(); };
            }, [user]);

            // Logic to support "Whole Day Lock" per user
            const getAvailableDeviceIds = (cartId, dateStr, period, exclusiveUser = null) => {
                const dayOfWeek = getDayOfWeek(dateStr);
                const cart = carts.find(c => c.id === cartId);
                if (!cart) return [];
                let available = new Set(ALL_DEVICES);
                
                const maintenance = cartStatus[cartId];
                if (maintenance && maintenance.brokenIds) maintenance.brokenIds.forEach(id => available.delete(id));
                else if (maintenance && maintenance.brokenCount) for(let i=1; i<=maintenance.brokenCount; i++) available.delete(i);

                bookings.forEach(b => {
                    if (b.cartId !== cartId || b.status === 'cancelled') return;

                    let isSameDate = false;
                    if (b.type === 'long-term') {
                        if (parseInt(b.dayOfWeek) === dayOfWeek && (!b.startDate || (dateStr >= b.startDate && dateStr <= b.endDate))) isSameDate = true;
                    } else if (b.date === dateStr) isSameDate = true;

                    if (isSameDate) {
                        const isSamePeriod = parseInt(b.period) === parseInt(period);
                        const isSameUser = exclusiveUser && b.user === exclusiveUser;

                        if (isSamePeriod) {
                             if (b.deviceIds) b.deviceIds.forEach(id => available.delete(id));
                        }
                        else if (!isSameUser) {
                             if (b.deviceIds) b.deviceIds.forEach(id => available.delete(id));
                        }
                    }
                });
                return Array.from(available).sort((a,b) => a-b);
            };

            const getAvailabilityCount = (cartId, dateStr, period, exclusiveUser = null) => {
                 const ids = getAvailableDeviceIds(cartId, dateStr, period, exclusiveUser);
                 let count = ids.length;
                 return Math.max(0, count);
            };

            const handleBackendAccess = () => {
                if (isAdmin) { setView('backend'); return; }
                setModalConfig({
                    type: 'password', title: '管理員登入', message: '請輸入管理後台密碼',
                    onConfirm: (val) => {
                        if (val === "wfjhadmin") { setIsAdmin(true); setView('backend'); showToast("登入成功"); }
                        else showToast("密碼錯誤", "error");
                    }
                });
            };

            const openReportModal = () => {
                setModalConfig({ type: 'custom', title: '今日出貨報表', render: ({ onClose }) => <DailyReportModal bookings={bookings} onClose={onClose} /> });
            };

            return (
                <div className="min-h-screen flex flex-col relative">
                    {/* Welcome Popup */}
                    {showWelcome && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] flex items-center justify-center p-4 animate-fade-in">
                            <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] flex flex-col overflow-hidden">
                                <div className="bg-blue-600 p-4 text-white text-center font-bold text-xl shrink-0">
                                    ⚠️ 租借注意事項
                                </div>
                                <div className="p-0 overflow-y-auto flex-grow flex justify-center bg-gray-100">
                                     <img 
                                        src="https://i.ibb.co/93hfxjtH/unnamed.jpg" 
                                        alt="租借規則說明" 
                                        className="max-w-full h-auto object-contain"
                                        onError={(e) => {
                                            e.target.style.display='none';
                                            e.target.parentNode.innerHTML = '<div class="p-8 text-center text-gray-500 flex flex-col items-center"><i data-lucide="image-off" class="w-12 h-12 mb-2"></i><p>圖片無法載入，請確認網路連線或連結權限。</p></div>';
                                            if(window.lucide) window.lucide.createIcons();
                                        }}
                                     />
                                </div>
                                <div className="p-4 bg-white border-t shrink-0">
                                    <button 
                                        onClick={() => setShowWelcome(false)}
                                        className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg text-lg transition shadow-md transform hover:scale-[1.01]"
                                    >
                                        我知道了，開始借用
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {toast && <Toast message={toast.message} type={toast.type} onClose={closeToast} />}
                    {modalConfig && <Modal isOpen={true} title={modalConfig.title} onClose={() => setModalConfig(null)}><ModalContent config={modalConfig} onClose={() => setModalConfig(null)} /></Modal>}
                    
                    <header className="bg-blue-600 text-white shadow-lg sticky top-0 z-40">
                        <div className="container mx-auto px-4 py-3 flex flex-wrap justify-between items-center gap-2">
                            <h1 className="text-xl font-bold flex items-center gap-2"><i data-lucide="tablet" className="w-6 h-6"></i> 五福國中平板車租借系統 v1.0</h1>
                            <div className="flex bg-blue-700 rounded-lg p-1 overflow-x-auto">
                                <button onClick={() => setView('frontend')} className={`px-3 py-1.5 rounded-md text-sm font-medium whitespace-nowrap transition ${view === 'frontend' ? 'bg-white text-blue-700 shadow' : 'text-blue-200 hover:text-white'}`}>單次預約</button>
                                <button onClick={() => setView('long-term')} className={`px-3 py-1.5 rounded-md text-sm font-medium whitespace-nowrap transition ${view === 'long-term' ? 'bg-white text-blue-700 shadow' : 'text-blue-200 hover:text-white'}`}>長期/批次預約</button>
                                <button onClick={() => setView('my-bookings')} className={`px-3 py-1.5 rounded-md text-sm font-medium whitespace-nowrap transition ${view === 'my-bookings' ? 'bg-white text-blue-700 shadow' : 'text-blue-200 hover:text-white'}`}>借閱確認</button>
                            </div>
                        </div>
                    </header>
                    <main className="container mx-auto px-4 py-6 flex-grow">
                        {carts.length === 0 ? (
                            <div className="flex flex-col items-center justify-center h-64 text-gray-500 gap-2"><div className="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div><p>系統資料載入中...</p></div>
                        ) : (
                            <>
                                {view === 'frontend' && <FrontendView carts={carts.filter(c => c.enableOneTime)} bookings={bookings} cartStatus={cartStatus} getAvailabilityCount={getAvailabilityCount} getAvailableDeviceIds={getAvailableDeviceIds} user={user} db={db} appId={appId} showToast={showToast} />}
                                {view === 'long-term' && <LongTermView carts={carts.filter(c => c.enableLongTerm)} getAvailabilityCount={getAvailabilityCount} getAvailableDeviceIds={getAvailableDeviceIds} user={user} db={db} appId={appId} showToast={showToast} />}
                                {view === 'my-bookings' && <MyBookingsView bookings={bookings} />}
                                {view === 'backend' && <BackendView carts={carts} bookings={bookings} cartStatus={cartStatus} db={db} appId={appId} showToast={showToast} setModalConfig={setModalConfig} />}
                            </>
                        )}
                    </main>
                    <footer className="bg-gray-800 text-gray-400 text-center py-4 text-sm">
                        &copy; {new Date().getFullYear()} 學校資訊組 | 
                        <button onClick={handleBackendAccess} className="ml-2 hover:text-white underline decoration-dotted transition">行政人員管理後台</button> | 
                        <button onClick={openReportModal} className="ml-2 hover:text-white underline decoration-dotted transition">今日出貨</button>
                    </footer>
                </div>
            );
        }

        function ModalContent({ config, onClose }) {
            const [val, setVal] = React.useState(config.defaultValue || '');
            const handleSubmit = (e) => { e.preventDefault(); config.onConfirm(val); onClose(); };
            if (config.type === 'confirm') {
                return (
                    <div>
                        <p className="text-gray-600 mb-4">{config.message}</p>
                        <div className="flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 bg-gray-200 rounded text-gray-700 hover:bg-gray-300">取消</button>
                            <button onClick={() => { config.onConfirm(); onClose(); }} className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">確定</button>
                        </div>
                    </div>
                );
            }
            if (config.type === 'custom') return config.render({ onClose });
            return (
                <form onSubmit={handleSubmit}>
                    <p className="text-gray-600 mb-2">{config.message}</p>
                    <input type={config.type === 'password' ? 'password' : 'text'} className="w-full border rounded p-2 mb-4 focus:ring-2 focus:ring-blue-500 outline-none" value={val} onChange={e => setVal(e.target.value)} autoFocus />
                    <div className="flex justify-end gap-2">
                        <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 rounded text-gray-700 hover:bg-gray-300">取消</button>
                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">確定</button>
                    </div>
                </form>
            );
        }

        // --- My Bookings View (NEW) ---
        function MyBookingsView({ bookings }) {
            const [name, setName] = React.useState('');
            const [result, setResult] = React.useState(null);

            React.useEffect(() => { if (window.lucide) window.lucide.createIcons(); });

            const groupBookings = (list) => {
                const groups = {};
                const singles = [];
                
                list.forEach(b => {
                    if (b.status === 'active' && b.type === 'long-term' && b.batchId) {
                        if (!groups[b.batchId]) {
                            groups[b.batchId] = {
                                ...b,
                                isGroup: true,
                                slots: []
                            };
                        }
                        groups[b.batchId].slots.push({ day: b.dayOfWeek, period: b.period });
                    } else {
                        singles.push(b);
                    }
                });

                const groupArray = Object.values(groups).map(g => {
                    g.slots.sort((a,b) => a.day - b.day || a.period - b.period);
                    const days = {};
                    g.slots.forEach(s => {
                        if(!days[s.day]) days[s.day] = [];
                        days[s.day].push(s.period);
                    });
                    const textParts = Object.keys(days).sort().map(d => {
                        return `週${DAY_LABELS[d]} / 第 ${days[d].join('、')} 節`;
                    });
                    g.scheduleText = textParts.join(' ; ');
                    return g;
                });

                return [...singles, ...groupArray].sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
            };

            const handleSearch = (e) => {
                e.preventDefault();
                if (!name.trim()) return;
                
                const found = bookings.filter(b => b.user.trim() === name.trim() && b.status === 'active');
                const grouped = groupBookings(found);
                
                setResult(grouped);
            };

            return (
                <div className="max-w-3xl mx-auto space-y-6 animate-fade-in">
                    <div className="bg-white p-6 rounded-lg card-shadow">
                        <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <i data-lucide="search" className="w-6 h-6 text-blue-600"></i>
                            借閱確認 / 查詢
                        </h2>
                        <form onSubmit={handleSearch} className="flex gap-2 mb-6">
                            <input 
                                type="text" 
                                className="flex-1 border rounded p-3 text-lg" 
                                placeholder="請輸入申請人姓名 (全名)" 
                                value={name} 
                                onChange={e => setName(e.target.value)}
                            />
                            <button type="submit" className="bg-blue-600 text-white px-6 py-3 rounded font-bold hover:bg-blue-700">查詢</button>
                        </form>

                        {result !== null && (
                            <div>
                                {result.length === 0 ? (
                                    <div className="text-center text-gray-500 py-8">查無資料，請確認姓名是否輸入正確。</div>
                                ) : (
                                    <div className="space-y-4">
                                        <h3 className="font-bold text-lg text-gray-700 border-b pb-2">查詢結果：{name} 老師 ({result.length} 筆)</h3>
                                        {result.map(b => (
                                            <div key={b.id || b.batchId} className="border rounded-lg p-4 hover:bg-gray-50 transition">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <div className="font-bold text-lg text-blue-800 flex items-center gap-2">
                                                            {b.type === 'long-term' ? <span className="bg-purple-100 text-purple-700 text-xs px-2 py-1 rounded">長期</span> : <span className="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded">單次</span>}
                                                            {b.type === 'long-term' ? `${b.startDate} ~ ${b.endDate}` : b.date}
                                                        </div>
                                                        <div className="text-gray-600 mt-1">
                                                            <span className="font-bold mr-2">{b.cartId}車 ({b.cartLoc})</span>
                                                            {b.isGroup ? (
                                                                <span className="block mt-1 font-medium text-gray-800">{b.scheduleText}</span>
                                                            ) : (
                                                                <span className="mr-2">週{['日','一','二','三','四','五','六'][b.dayOfWeek]} 第 {b.period} 節</span>
                                                            )}
                                                            <span className="text-sm text-gray-500 ml-2">(數量: {b.quantity})</span>
                                                        </div>
                                                        <div className="text-sm text-gray-500 mt-2 bg-gray-100 p-2 rounded">
                                                            分配編號：{formatDeviceList(b.deviceIds)}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // --- Frontend View ---
        function FrontendView({ carts, bookings, cartStatus, getAvailabilityCount, getAvailableDeviceIds, user, db, appId, showToast }) {
            const [date, setDate] = React.useState(getMinDate());
            const [selectedSlot, setSelectedSlot] = React.useState(null); 
            const [form, setForm] = React.useState({ user: '', ext: '', quantity: 30, needTeacherPad: false, note: '', type: 'one-time' });
            
            React.useEffect(() => { if (window.lucide) window.lucide.createIcons(); });

            // Generate Device Status Map for UI
            const getDeviceStatusMap = (cartId, dateStr, period) => {
                const dayOfWeek = getDayOfWeek(dateStr);
                const map = {}; 
                for(let i=1; i<=36; i++) map[i] = { status: 'available', label: '可借' };

                // 1. Maintenance
                const maintenance = cartStatus[cartId];
                if (maintenance) {
                    if (maintenance.brokenIds) {
                        maintenance.brokenIds.forEach(id => map[id] = { status: 'locked', label: '維修/鎖定' });
                    } else if (maintenance.brokenCount) {
                        // Legacy support
                        for(let i=1; i<=maintenance.brokenCount; i++) map[i] = { status: 'locked', label: '維修/鎖定' };
                    }
                }

                // 2. Bookings
                bookings.forEach(b => {
                    if (b.cartId !== cartId || b.status === 'cancelled') return;
                    
                    let isSameDate = false;
                    if (b.type === 'long-term') {
                        if (parseInt(b.dayOfWeek) === dayOfWeek && (!b.startDate || (dateStr >= b.startDate && dateStr <= b.endDate))) isSameDate = true;
                    } else if (b.date === dateStr) isSameDate = true;

                    if (isSameDate && b.deviceIds) {
                         if (parseInt(b.period) === parseInt(period)) {
                             b.deviceIds.forEach(id => { if (map[id]) map[id] = { status: 'booked', label: b.user }; });
                         }
                         else {
                             b.deviceIds.forEach(id => { 
                                 if (map[id]) {
                                     if(map[id].status === 'available') {
                                         map[id] = { status: 'booked', label: `${b.user} (全日)` }; 
                                     }
                                 } 
                             });
                         }
                    }
                });
                return map;
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!user) return;
                const dBook = new Date(date);
                const dToday = new Date(); dToday.setHours(0,0,0,0);
                if ((dBook - dToday) / (1000 * 3600 * 24) < 2) { showToast("錯誤：必須於兩天前預約", "error"); return; }
                const availableIds = getAvailableDeviceIds(selectedSlot.cart.id, date, selectedSlot.period, form.user);
                const needed = parseInt(form.quantity) + (form.needTeacherPad ? 1 : 0);
                if (needed > availableIds.length) { showToast(`庫存不足！該時段僅剩 ${availableIds.length} 台`, "error"); return; }
                const userBookingsToday = bookings.filter(b => b.date === date && b.cartId === selectedSlot.cart.id && b.user === form.user && b.status === 'active');
                const preferredIds = new Set();
                userBookingsToday.forEach(b => b.deviceIds.forEach(id => preferredIds.add(id)));
                availableIds.sort((a, b) => {
                    const aPref = preferredIds.has(a);
                    const bPref = preferredIds.has(b);
                    if (aPref && !bPref) return -1;
                    if (!aPref && bPref) return 1;
                    return a - b;
                });
                const assignedIds = availableIds.slice(0, needed);
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'bookings'), { ...form, cartId: selectedSlot.cart.id, cartLoc: selectedSlot.cart.location, date: date, dayOfWeek: getDayOfWeek(date), period: selectedSlot.period, status: 'active', deviceIds: assignedIds, createdAt: serverTimestamp(), createdBy: user.uid });
                    
                    // Send Email Notification
                    const emailData = {
                        type: 'one-time',
                        user: form.user,
                        ext: form.ext,
                        dateStr: date,
                        periodStr: `第 ${selectedSlot.period} 節`,
                        cartId: selectedSlot.cart.id,
                        quantity: needed,
                        deviceStr: formatDeviceList(assignedIds),
                        note: form.note || "無"
                    };
                    sendEmailNotification(emailData);

                    showToast(`預約成功！分配編號: ${formatDeviceList(assignedIds)}`); setSelectedSlot(null); setForm({ ...form, note: '', quantity: 30 });
                } catch (err) { showToast("預約失敗", "error"); }
            };

            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="bg-white p-5 rounded-lg card-shadow border-l-4 border-blue-500 flex flex-wrap items-end gap-4 justify-between">
                        <div><h2 className="text-2xl font-bold text-gray-800">單次預約平板</h2><p className="text-gray-500 text-sm mt-1">若老師您是每周固定租借的需求請點選上方（長期/批次預約）。目前系統僅開放前兩天進行預約，若有特殊需求的老師請直接聯絡資訊執秘（分機：18），謝謝！</p></div>
                        <div className="flex flex-col gap-1"><label className="text-sm font-bold text-gray-700">選擇日期</label><input type="date" min={getMinDate()} value={date} onChange={e => setDate(e.target.value)} className="border-2 border-blue-200 rounded px-3 py-2 text-lg focus:ring-2 focus:ring-blue-500 outline-none" /></div>
                    </div>
                    <div className="bg-white rounded-lg card-shadow overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-center whitespace-nowrap">
                                <thead className="bg-gray-100 border-b">
                                    <tr><th className="p-4 text-left font-bold text-gray-600 sticky left-0 bg-gray-100 z-10">車號 / 位置</th>{PERIODS.map(p => <th key={p} className="p-4 font-bold text-gray-600 min-w-[80px]">第 {p} 節</th>)}</tr>
                                </thead>
                                <tbody className="divide-y">
                                    {carts.map(cart => (
                                        <tr key={cart.id} className="hover:bg-gray-50">
                                            <td className="p-3 text-left sticky left-0 bg-white z-10 border-r group-hover:bg-gray-50"><div className="flex items-center gap-2"><span className="bg-blue-100 text-blue-800 font-bold px-2 py-1 rounded">{cart.id} 車</span><span className="text-xs text-gray-500">{cart.location}</span></div></td>
                                            {PERIODS.map(p => {
                                                const avail = getAvailabilityCount(cart.id, date, p);
                                                const statusColor = avail === 0 ? 'bg-red-50 text-red-400' : avail < 10 ? 'bg-yellow-50 text-yellow-700' : 'bg-green-50 text-green-700';
                                                return (<td key={p} className="p-2"><button disabled={avail === 0} onClick={() => setSelectedSlot({ cart, period: p, available: avail })} className={`w-full h-12 rounded-lg flex flex-col items-center justify-center transition ${statusColor} ${avail > 0 ? 'hover:scale-105 shadow-sm' : 'cursor-not-allowed opacity-60'}`}><span className="font-bold">{avail}</span><span className="text-[10px] opacity-80">可借</span></button></td>);
                                            })}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {selectedSlot && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-fade-in">
                            <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full overflow-hidden flex flex-col max-h-[90vh]">
                                <div className="bg-blue-600 p-4 flex justify-between items-center text-white flex-shrink-0"><h3 className="font-bold text-lg">預約單 - {selectedSlot.cart.id}車 第{selectedSlot.period}節</h3><button onClick={() => setSelectedSlot(null)} className="hover:bg-blue-700 p-1 rounded"><i data-lucide="x"></i></button></div>
                                <div className="p-6 overflow-y-auto flex-grow">
                                    <div className="mb-6">
                                        <h4 className="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2"><i data-lucide="grid" className="w-4 h-4"></i> 即時庫存狀態表 (當日)</h4>
                                        <div className="grid grid-cols-6 sm:grid-cols-9 gap-1.5">
                                            {ALL_DEVICES.map(n => {
                                                const status = getDeviceStatusMap(selectedSlot.cart.id, date, selectedSlot.period)[n];
                                                let bgClass = "bg-green-100 border-green-300 text-green-700";
                                                if (status.status === 'locked') bgClass = "bg-red-100 border-red-300 text-red-700";
                                                if (status.status === 'booked') bgClass = "bg-blue-100 border-blue-300 text-blue-700";
                                                return (<div key={n} title={status.status === 'booked' ? `借用人: ${status.label}` : status.label} className={`border rounded p-1 text-center text-xs flex flex-col justify-center items-center h-10 ${bgClass}`}><span className="font-bold">{n}</span>{status.status === 'booked' && <span className="scale-75 w-full truncate">{status.label}</span>}</div>)
                                            })}
                                        </div>
                                        <div className="flex gap-4 mt-2 text-xs text-gray-500 justify-end"><div className="flex items-center gap-1"><div className="w-3 h-3 bg-green-100 border border-green-300 rounded"></div>可借</div><div className="flex items-center gap-1"><div className="w-3 h-3 bg-blue-100 border border-blue-300 rounded"></div>已借出/全日鎖定</div><div className="flex items-center gap-1"><div className="w-3 h-3 bg-red-100 border border-red-300 rounded"></div>維修</div></div>
                                    </div>
                                    <form onSubmit={handleSubmit} className="space-y-4 border-t pt-4">
                                        <div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-bold text-gray-700 mb-1">申請人 (請填全名)</label><input required type="text" value={form.user} onChange={e => setForm({...form, user: e.target.value})} className="w-full border rounded px-3 py-2" placeholder="王老師" /></div><div><label className="block text-sm font-bold text-gray-700 mb-1">分機</label><input required type="text" value={form.ext} onChange={e => setForm({...form, ext: e.target.value})} className="w-full border rounded px-3 py-2" /></div></div>
                                        <div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-bold text-gray-700 mb-1">學生機數量</label><input required type="number" min="1" max="36" value={form.quantity} onChange={e => setForm({...form, quantity: e.target.value})} className="w-full border rounded px-3 py-2" /></div><div className="flex items-center pt-6"><label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={form.needTeacherPad} onChange={e => setForm({...form, needTeacherPad: e.target.checked})} className="w-5 h-5 accent-blue-600" /><span className="text-gray-700 font-medium">需教師機 (+1)</span></label></div></div>
                                        <div><label className="block text-sm font-bold text-gray-700 mb-1">備註</label><textarea value={form.note} onChange={e => setForm({...form, note: e.target.value})} className="w-full border rounded px-3 py-2" rows="2"></textarea></div>
                                        <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow transition">確認送出</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- Long Term View ---
        function LongTermView({ carts, getAvailabilityCount, getAvailableDeviceIds, user, db, appId, showToast }) {
            const [step, setStep] = React.useState(1);
            const [checkResult, setCheckResult] = React.useState(null);
            const [form, setForm] = React.useState({ startDate: getMinDate(), endDate: addDays(getMinDate(), 30), cartId: '', user: '', ext: '', quantity: 30, needTeacherPad: false, note: '', selectedSlots: [] });
            React.useEffect(() => { if (carts.length > 0 && !form.cartId) setForm(f => ({...f, cartId: carts[0].id})); }, [carts]);
            React.useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [step]);
            const toggleSlot = (day, period) => {
                const exists = form.selectedSlots.find(s => s.day === day && s.period === period);
                if (exists) setForm({ ...form, selectedSlots: form.selectedSlots.filter(s => s !== exists) });
                else setForm({ ...form, selectedSlots: [...form.selectedSlots, { day, period }] });
                setCheckResult(null);
            };
            
            const checkConflicts = () => {
                if (form.selectedSlots.length === 0) { showToast("請至少選擇一個時段", "error"); return; }
                if (form.startDate > form.endDate) { showToast("結束日期不能早於開始日期", "error"); return; }
                const needed = parseInt(form.quantity) + (form.needTeacherPad ? 1 : 0);
                let foundCartId = null;
                for (const cart of carts) {
                    let isCartValid = true;
                    let curr = new Date(form.startDate);
                    const end = new Date(form.endDate);
                    while (curr <= end) {
                        const dateStr = formatDate(curr);
                        const dayOfWeek = curr.getDay(); 
                        const daySlots = form.selectedSlots.filter(s => s.day === dayOfWeek);
                        for (const slot of daySlots) {
                            const availCount = getAvailabilityCount(cart.id, dateStr, slot.period, null);
                            if (availCount < needed) { isCartValid = false; break; }
                        }
                        if (!isCartValid) break; 
                        curr.setDate(curr.getDate() + 1);
                    }
                    if (isCartValid) { foundCartId = cart.id; break; }
                }
                if (foundCartId) { setForm(prev => ({ ...prev, cartId: foundCartId })); setCheckResult([]); showToast(`自動分配：${foundCartId} 車`); } else { setCheckResult([{ error: "所有車輛在指定時段皆無足夠庫存" }]); }
            };

            const handleConfirm = async () => {
                if (!checkResult || checkResult.length > 0) return;
                try {
                    let curr = new Date(form.startDate);
                    const end = new Date(form.endDate);
                    let globalIntersection = new Set(ALL_DEVICES); 
                    const needed = parseInt(form.quantity) + (form.needTeacherPad ? 1 : 0);
                    const intersectionMap = {};
                    form.selectedSlots.forEach(s => intersectionMap[`${s.day}-${s.period}`] = new Set(ALL_DEVICES));
                    while(curr <= end) {
                        const dStr = formatDate(curr);
                        const dow = curr.getDay();
                        form.selectedSlots.filter(s => s.day === dow).forEach(s => {
                             const idsOnDate = getAvailableDeviceIds(form.cartId, dStr, s.period, form.user);
                             const slotSet = intersectionMap[`${dow}-${s.period}`];
                             for (let id of slotSet) if (!idsOnDate.includes(id)) slotSet.delete(id);
                             for (let id of globalIntersection) if (!idsOnDate.includes(id)) globalIntersection.delete(id);
                        });
                        curr.setDate(curr.getDate() + 1);
                    }
                    let useGlobal = globalIntersection.size >= needed;
                    let assignedIdsGlobal = [];
                    if (useGlobal) assignedIdsGlobal = Array.from(globalIntersection).sort((a,b)=>a-b).slice(0, needed);
                    const batch = writeBatch(db);
                    const batchId = crypto.randomUUID();
                    let fail = false;
                    form.selectedSlots.forEach(s => {
                        let assignedIds = [];
                        if (useGlobal) assignedIds = assignedIdsGlobal;
                        else {
                            const availableSet = intersectionMap[`${s.day}-${s.period}`];
                            if (availableSet.size < needed) { fail = true; return; }
                            assignedIds = Array.from(availableSet).sort((a,b)=>a-b).slice(0, needed);
                        }
                        const ref = doc(collection(db, 'artifacts', appId, 'public', 'data', 'bookings'));
                        batch.set(ref, { type: 'long-term', batchId: batchId, startDate: form.startDate, endDate: form.endDate, dayOfWeek: s.day, period: s.period, cartId: form.cartId, cartLoc: carts.find(c => c.id === form.cartId).location, user: form.user, ext: form.ext, quantity: parseInt(form.quantity), needTeacherPad: form.needTeacherPad, note: form.note, status: 'active', deviceIds: assignedIds, createdAt: serverTimestamp(), createdBy: user.uid });
                    });
                    if(fail) { showToast("部分時段無法分配連續相同的編號", "error"); return; }
                    await batch.commit(); 
                    
                    // Send Email Notification (Batch)
                    const emailData = {
                        type: 'long-term',
                        user: form.user,
                        ext: form.ext,
                        dateStr: `${form.startDate} ~ ${form.endDate}`,
                        periodStr: `共 ${form.selectedSlots.length} 個時段`, 
                        cartId: form.cartId,
                        quantity: needed,
                        deviceStr: useGlobal ? formatDeviceList(assignedIdsGlobal) + " (全期固定)" : "依時段分配 (詳見系統)",
                        note: form.note || "無"
                    };
                    sendEmailNotification(emailData);

                    showToast(useGlobal ? "租借成功！全程鎖定相同編號。" : "租借成功！每週固定時段編號相同。"); 
                    setForm({ ...form, selectedSlots: [], user: '', ext: '', note: '' }); setCheckResult(null); setStep(1);
                } catch (e) { showToast("建立失敗", "error"); }
            };

            return (
                <div className="max-w-4xl mx-auto space-y-6 animate-fade-in">
                    <div className="bg-white p-6 rounded-lg card-shadow">
                        <div className="border-b pb-4 mb-4"><h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2"><i data-lucide="calendar-range" className="w-6 h-6 text-purple-600"></i> 長期/批次預約平板</h2><p className="text-gray-500 mt-1">系統將自動尋找可用的車輛與連續編號。</p></div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"><div><label className="block text-sm font-bold text-gray-700 mb-2">1. 日期區間</label><div className="flex items-center gap-2"><input type="date" className="border rounded p-2 w-full" value={form.startDate} onChange={e => setForm({...form, startDate: e.target.value, checkResult: null})} /><span className="text-gray-400">至</span><input type="date" className="border rounded p-2 w-full" value={form.endDate} onChange={e => setForm({...form, endDate: e.target.value, checkResult: null})} /></div></div></div>
                        <div className="mb-6"><label className="block text-sm font-bold text-gray-700 mb-2">2. 勾選每週固定時段</label><div className="overflow-x-auto border rounded-lg"><table className="w-full text-center text-sm"><thead className="bg-purple-50 text-purple-900 font-bold"><tr><th className="p-2 border-b border-r">節次</th>{DAYS_OF_WEEK.map(d => <th key={d} className="p-2 border-b min-w-[60px]">週{DAY_LABELS[d]}</th>)}</tr></thead><tbody>{PERIODS.map(p => (<tr key={p} className="hover:bg-gray-50"><td className="p-2 border-r font-bold text-gray-500">第 {p} 節</td>{DAYS_OF_WEEK.map(d => { const isSelected = form.selectedSlots.some(s => s.day === d && s.period === p); return (<td key={d} className="p-1 border matrix-cell"><label className="cursor-pointer block h-full w-full"><input type="checkbox" className="hidden" checked={isSelected} onChange={() => toggleSlot(d, p)} /><div className={`py-3 rounded transition hover:bg-blue-50 ${isSelected ? 'bg-blue-100 text-blue-700 font-bold ring-2 ring-blue-300' : 'text-gray-300'}`}>{isSelected ? '✅' : '-'}</div></label></td>) })}</tr>))}</tbody></table></div></div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded border"><div><label className="block text-xs font-bold text-gray-500">申請人</label><input type="text" className="w-full border rounded p-2 mt-1" placeholder="王小明" value={form.user} onChange={e => setForm({...form, user: e.target.value})} /></div><div><label className="block text-xs font-bold text-gray-500">分機</label><input type="text" className="w-full border rounded p-2 mt-1" placeholder="1234" value={form.ext} onChange={e => setForm({...form, ext: e.target.value})} /></div><div><label className="block text-xs font-bold text-gray-500">數量</label><div className="flex gap-2 items-center mt-1"><input type="number" className="w-20 border rounded p-2" value={form.quantity} onChange={e => setForm({...form, quantity: e.target.value})} /><label className="flex items-center gap-1 text-sm text-gray-700 cursor-pointer"><input type="checkbox" checked={form.needTeacherPad} onChange={e => setForm({...form, needTeacherPad: e.target.checked})} />需教師機</label></div></div></div>
                        <div className="mb-6"><label className="block text-sm font-bold text-gray-700 mb-1">備註</label><textarea value={form.note} onChange={e => setForm({...form, note: e.target.value})} className="w-full border rounded px-3 py-2" rows="2"></textarea></div>
                        <div className="flex justify-end gap-3">{!checkResult ? (<button onClick={checkConflicts} disabled={form.selectedSlots.length === 0} className="bg-purple-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-purple-700 disabled:opacity-50 transition shadow">檢查庫存狀況</button>) : (<div className="w-full">{checkResult.length === 0 ? (<div className="bg-green-50 border border-green-200 text-green-800 p-4 rounded-lg flex justify-between items-center mb-4"><div className="flex items-center gap-2"><i data-lucide="check-circle" className="w-6 h-6 text-green-600"></i><span>檢查通過！</span></div><button onClick={handleConfirm} className="bg-green-600 text-white px-6 py-2 rounded shadow hover:bg-green-700 font-bold">確認預約</button></div>) : (<div className="bg-red-50 border border-red-200 text-red-800 p-4 rounded-lg mb-4"><div className="font-bold flex items-center gap-2 mb-2"><i data-lucide="x-circle" className="w-5 h-5"></i>{checkResult[0].error || `發現 ${checkResult.length} 個衝突時段`}</div><button onClick={() => setCheckResult(null)} className="mt-2 text-red-600 underline text-sm hover:text-red-800">返回修改</button></div>)}</div>)}</div>
                    </div>
                </div>
            );
        }

        // --- Backend View ---
        function BackendView({ carts, bookings, cartStatus, db, appId, showToast, setModalConfig }) {
            const [filter, setFilter] = React.useState('all');
            const [isAddingCart, setIsAddingCart] = React.useState(false);
            const [newCart, setNewCart] = React.useState({ id: '', location: '', total: 36, enableOneTime: true, enableLongTerm: true });
            const [editingMaintenance, setEditingMaintenance] = React.useState(null);

            React.useEffect(() => { if (window.lucide) window.lucide.createIcons(); });

            const handleDelete = (item) => {
                const isBatch = item.isGroup;
                const msg = isBatch ? '確定要刪除這筆「長期預約」嗎？這將會刪除該批次的所有預約紀錄。' : '確定要刪除這筆預約紀錄嗎？';
                setModalConfig({ type: 'confirm', title: '確認刪除', message: msg, onConfirm: async () => { try { if (isBatch) { const batch = writeBatch(db); const idsToDelete = bookings.filter(b => b.batchId === item.batchId).map(b => b.id); idsToDelete.forEach(id => batch.delete(doc(db, 'artifacts', appId, 'public', 'data', 'bookings', id))); await batch.commit(); } else { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bookings', item.id)); } showToast("刪除成功"); } catch(e) { showToast("刪除失敗", "error"); } } });
            };

            const handleEdit = (item) => {
                setModalConfig({ type: 'custom', title: `編輯分配 - ${item.user} (${item.cartId}車)`, render: ({ onClose }) => ( <AllocationEditor item={item} allBookings={bookings} carts={carts} cartStatus={cartStatus} onClose={onClose} onSave={async (newIds, newCartId) => { try { const targetCart = carts.find(c => c.id === newCartId); const newLoc = targetCart ? targetCart.location : item.cartLoc; if (item.isGroup) { const batch = writeBatch(db); const relatedDocs = bookings.filter(b => b.batchId === item.batchId); relatedDocs.forEach(docData => { const ref = doc(db, 'artifacts', appId, 'public', 'data', 'bookings', docData.id); batch.update(ref, { deviceIds: newIds, quantity: newIds.length, cartId: newCartId, cartLoc: newLoc }); }); await batch.commit(); showToast(`已更新批次共 ${relatedDocs.length} 筆預約`); } else { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bookings', item.id), { deviceIds: newIds, quantity: newIds.length, cartId: newCartId, cartLoc: newLoc }); showToast("更新成功"); } onClose(); } catch(e) { showToast("更新失敗", "error"); } }} showToast={showToast} /> ) });
            };

            const openMaintenanceModal = (cartId) => { const status = cartStatus[cartId] || {}; let ids = status.brokenIds || (status.brokenCount ? Array.from({length: status.brokenCount}, (_,i)=>i+1) : []); setEditingMaintenance({ cartId, brokenIds: new Set(ids) }); setModalConfig({ type: 'custom', title: `${cartId} 車 - 鎖定管理`, render: ({ onClose }) => <MaintenanceGrid cartId={cartId} initialIds={ids} onClose={onClose} db={db} appId={appId} showToast={showToast} /> }); };
            
            const handleAddCart = async () => { if (!newCart.id || !newCart.location) return showToast("請填寫完整資訊", "error"); try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'carts', newCart.id.toUpperCase()), { ...newCart, id: newCart.id.toUpperCase() }); setIsAddingCart(false); setNewCart({ id: '', location: '', total: 36, enableOneTime: true, enableLongTerm: true }); showToast("新增成功"); } catch(e) { showToast("新增失敗", "error"); } };
            const handleUpdateCart = async (cart, field, val) => await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'carts', cart.id), { [field]: val });
            const handleDeleteCart = (id) => { setModalConfig({ type: 'confirm', title: '確認刪除車輛', message: `確定要刪除 ${id} 車嗎？`, onConfirm: async () => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'carts', id)); showToast("已刪除"); } }); };
            
            const exportCSV = () => { const headers = ["類型,日期範圍/單日,車號,節次,申請人,分機,學生機,教師機,分配編號,備註,狀態,建立時間"]; const rows = bookings.map(b => { const type = b.type === 'long-term' ? '長期' : '單次'; let dateInfo = b.date; if(b.type === 'long-term') dateInfo = `${b.startDate}~${b.endDate} (週${DAY_LABELS[b.dayOfWeek]})`; const created = b.createdAt ? new Date(b.createdAt.seconds * 1000).toLocaleString() : ''; return `${type},"${dateInfo}",${b.cartId},${b.period},${b.user},${b.ext},${b.quantity},${b.needTeacherPad?'是':'否'},"${formatDeviceList(b.deviceIds)}",${b.note || ''},${b.status},${created}`; }); const link = document.createElement("a"); link.setAttribute("href", URL.createObjectURL(new Blob(["\uFEFF" + headers.concat(rows).join("\n")], { type: 'text/csv;charset=utf-8;' }))); link.setAttribute("download", `報表_${new Date().toISOString().slice(0,10)}.csv`); document.body.appendChild(link); link.click(); };

            const groupBookings = (list) => { const groups = {}; const singles = []; list.forEach(b => { if (b.status === 'active' && b.type === 'long-term' && b.batchId) { if (!groups[b.batchId]) groups[b.batchId] = { ...b, isGroup: true, slots: [] }; groups[b.batchId].slots.push({ day: b.dayOfWeek, period: b.period }); } else singles.push(b); }); const groupArray = Object.values(groups).map(g => { g.slots.sort((a,b) => a.day - b.day || a.period - b.period); const days = {}; g.slots.forEach(s => { if(!days[s.day]) days[s.day] = []; days[s.day].push(s.period); }); const textParts = Object.keys(days).sort().map(d => `週${DAY_LABELS[d]} / 第 ${days[d].join('、')} 節`); g.scheduleText = textParts.join(' ; '); return g; }); return [...singles, ...groupArray].sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0)); };

            const rawList = bookings.filter(b => { if (filter === 'active') return b.status === 'active'; if (filter === 'long-term') return b.type === 'long-term'; return true; });
            const displayList = groupBookings(rawList);

            return (
                <div className="space-y-8 animate-fade-in">
                    
                    <div className="bg-white p-5 rounded-lg card-shadow border-t-4 border-gray-600">
                        <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg flex items-center gap-2 text-gray-800"><i data-lucide="truck" className="w-5 h-5"></i> 車輛管理設定</h3><button onClick={() => setIsAddingCart(true)} className="bg-gray-800 text-white px-3 py-1 rounded text-sm hover:bg-black transition flex items-center gap-1"><i data-lucide="plus" className="w-4 h-4"></i> 新增車輛</button></div>
                        {isAddingCart && ( <div className="bg-gray-100 p-4 rounded mb-4 animate-fade-in"><h4 className="font-bold text-sm mb-2">新增車輛</h4><div className="flex flex-wrap gap-2 items-end"><div className="w-20"><label className="text-xs">代號</label><input type="text" className="w-full border p-1 rounded uppercase" placeholder="Z" value={newCart.id} onChange={e => setNewCart({...newCart, id: e.target.value})} /></div><div className="flex-1"><label className="text-xs">位置</label><input type="text" className="w-full border p-1 rounded" placeholder="教務處" value={newCart.location} onChange={e => setNewCart({...newCart, location: e.target.value})} /></div><div className="w-20"><label className="text-xs">總量</label><input type="number" className="w-full border p-1 rounded" value={newCart.total} onChange={e => setNewCart({...newCart, total: parseInt(e.target.value)})} /></div><button onClick={handleAddCart} className="bg-green-600 text-white px-3 py-1 rounded text-sm">儲存</button><button onClick={() => setIsAddingCart(false)} className="text-gray-500 text-sm px-2">取消</button></div></div> )}
                        <div className="overflow-x-auto"><table className="w-full text-sm text-left border-collapse"><thead className="bg-gray-50 text-gray-600"><tr><th className="p-2 border">ID</th><th className="p-2 border">位置</th><th className="p-2 border">單次</th><th className="p-2 border">長期</th><th className="p-2 border text-right">操作</th></tr></thead><tbody>{carts.map(c => (<tr key={c.id} className="hover:bg-gray-50"><td className="p-2 border font-bold">{c.id}</td><td className="p-2 border"><input type="text" className="bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-500 outline-none w-full" defaultValue={c.location} onBlur={(e) => handleUpdateCart(c, 'location', e.target.value)} /></td><td className="p-2 border text-center"><input type="checkbox" checked={c.enableOneTime} onChange={(e) => handleUpdateCart(c, 'enableOneTime', e.target.checked)} className="accent-blue-600 w-4 h-4" /></td><td className="p-2 border text-center"><input type="checkbox" checked={c.enableLongTerm} onChange={(e) => handleUpdateCart(c, 'enableLongTerm', e.target.checked)} className="accent-blue-600 w-4 h-4" /></td><td className="p-2 border text-right"><button onClick={() => handleDeleteCart(c.id)} className="text-red-400 hover:text-red-600 px-2"><i data-lucide="trash" className="w-4 h-4"></i></button></td></tr>))}</tbody></table></div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <div className="lg:col-span-1 bg-white p-5 rounded-lg card-shadow h-fit"><h3 className="font-bold text-lg mb-4 flex items-center gap-2 text-gray-700"><i data-lucide="tool" className="w-5 h-5"></i> 鎖定控制管理</h3><div className="space-y-2 max-h-[600px] overflow-y-auto pr-1 custom-scrollbar">{carts.map(cart => { const status = cartStatus[cart.id] || {}; const brokenCount = status.brokenIds ? status.brokenIds.length : (status.brokenCount || 0); return (<div key={cart.id} className="border rounded p-3 bg-gray-50 flex justify-between items-center"><div><div className="font-bold text-gray-700">{cart.id} 車</div><div className="text-xs text-gray-500">{cart.location}</div></div><div className="flex items-center gap-2"><span className={`text-sm font-bold ${brokenCount > 0 ? 'text-red-600' : 'text-green-600'}`}>{brokenCount > 0 ? `鎖定 ${brokenCount}` : '正常'}</span><button onClick={() => openMaintenanceModal(cart.id)} className="text-gray-400 hover:text-blue-600"><i data-lucide="settings-2" className="w-4 h-4"></i></button></div></div>) })}</div></div>
                        <div className="lg:col-span-3 bg-white p-5 rounded-lg card-shadow">
                            <div className="flex flex-wrap justify-between items-center mb-6 gap-4">
                                <h3 className="font-bold text-lg flex items-center gap-2 text-gray-700"><i data-lucide="list" className="w-5 h-5"></i> 預約紀錄</h3>
                                <div className="flex gap-2">
                                    <button onClick={exportCSV} className="flex items-center gap-1 px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700 transition"><i data-lucide="download" className="w-4 h-4"></i> CSV</button>
                                    <div className="bg-gray-100 rounded p-1 flex">{['all','active','long-term'].map(f => <button key={f} onClick={() => setFilter(f)} className={`px-3 py-1 rounded text-sm ${filter === f ? 'bg-white shadow text-blue-600 font-bold' : 'text-gray-500 hover:text-gray-700'}`}>{f==='all'?'全部':f==='active'?'有效':'長期'}</button>)}</div>
                                </div>
                            </div>
                            <div className="overflow-x-auto"><table className="w-full text-sm text-left"><thead className="bg-gray-50 text-gray-600 uppercase"><tr><th className="p-3">類型/時間</th><th className="p-3">車號</th><th className="p-3">借用人</th><th className="p-3">數量</th><th className="p-3">分配編號</th><th className="p-3">操作</th></tr></thead><tbody className="divide-y">{displayList.map(b => (<tr key={b.id || b.batchId} className="hover:bg-gray-50"><td className="p-3">{b.type === 'long-term' ? (<div><span className="px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs font-bold mr-2">長期</span><br/>{b.startDate}~{b.endDate}<div className="text-purple-600 text-xs mt-1 font-bold">{b.isGroup ? b.scheduleText : `週${DAY_LABELS[b.dayOfWeek]} / 第 ${b.period} 節`}</div></div>) : (<div><span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-bold mr-2">單次</span><br/>{b.date}<div className="text-gray-500 text-xs mt-1">第 {b.period} 節</div></div>)}</td><td className="p-3 font-bold text-gray-700">{b.cartId} 車</td><td className="p-3"><div>{b.user}</div><div className="text-xs text-gray-400">分機 {b.ext}</div></td><td className="p-3">{b.quantity} 生 {b.needTeacherPad && '+ 1 師'}</td><td className="p-3 text-xs text-gray-600 max-w-[150px] truncate" title={formatDeviceList(b.deviceIds)}>{formatDeviceList(b.deviceIds)}</td><td className="p-3 flex gap-2"><button onClick={() => handleDelete(b)} className="text-red-500 hover:bg-red-50 p-2 rounded"><i data-lucide="trash-2" className="w-4 h-4"></i></button><button onClick={() => handleEdit(b)} className="text-blue-500 hover:bg-blue-50 p-2 rounded"><i data-lucide="edit" className="w-4 h-4"></i></button></td></tr>))}{displayList.length === 0 && <tr><td colSpan="6" className="p-8 text-center text-gray-400">無資料</td></tr>}</tbody></table></div>
                        </div>
                    </div>
                </div>
            );
        }

        // AllocationEditor
        function AllocationEditor({ item, allBookings, carts, cartStatus, onClose, onSave, showToast }) {
            const [selected, setSelected] = React.useState(new Set(item.deviceIds || []));
            const [targetCartId, setTargetCartId] = React.useState(item.cartId); 
            const [statusMap, setStatusMap] = React.useState({});

            React.useEffect(() => {
                const map = {}; for(let i=1; i<=36; i++) map[i] = { status: 'free', label: '' };
                const maintenance = cartStatus[targetCartId]; 
                if (maintenance) { const broken = maintenance.brokenIds || (maintenance.brokenCount ? Array.from({length:maintenance.brokenCount},(_,i)=>i+1) : []); broken.forEach(id => { map[id].status = 'locked'; map[id].label = '維修'; }); }

                if (item.isGroup) {
                    allBookings.forEach(other => {
                        if (other.status === 'cancelled' || other.cartId !== targetCartId) return; 
                        if (item.isGroup && other.batchId === item.batchId) return;
                        const rangeA = item.isGroup ? { start: item.startDate, end: item.endDate } : { start: item.date, end: item.date };
                        const rangeB = other.type === 'long-term' ? { start: other.startDate, end: other.endDate } : { start: other.date, end: other.date };
                        if (rangeA.start <= rangeB.end && rangeA.end >= rangeB.start) {
                            const itemSlots = item.isGroup ? item.slots : [{ day: getDayOfWeek(item.date), period: item.period }];
                            const otherSlots = other.type === 'long-term' ? [{ day: other.dayOfWeek, period: other.period }] : [{ day: getDayOfWeek(other.date), period: other.period }];
                            const collision = itemSlots.some(sA => otherSlots.some(sB => sA.day === (other.type==='long-term' ? other.dayOfWeek : getDayOfWeek(other.date)) && sA.period === other.period));
                            if (collision) { other.deviceIds.forEach(id => { if (map[id]) { map[id].status = 'busy'; map[id].label = other.user; } }); }
                        }
                    });
                } else {
                    allBookings.forEach(other => {
                        if (other.status === 'cancelled' || other.cartId !== targetCartId) return; 
                        if (other.id === item.id) return;
                        let overlap = false;
                        if (other.type === 'long-term') { if (getDayOfWeek(item.date) === other.dayOfWeek && item.period === other.period) { if (!other.startDate || (item.date >= other.startDate && item.date <= other.endDate)) overlap = true; } } else { if (other.date === item.date && other.period === item.period) overlap = true; }
                        if (overlap) { other.deviceIds.forEach(id => { if(map[id]) { map[id].status = 'busy'; map[id].label = other.user; } }); }
                    });
                }
                setStatusMap(map);
            }, [item, allBookings, cartStatus, targetCartId]);

            const toggle = (id) => { const s = statusMap[id]; if (!s) return; const next = new Set(selected); if (next.has(id)) next.delete(id); else next.add(id); setSelected(next); };
            const handleSave = () => { onSave(Array.from(selected).sort((a,b)=>a-b), targetCartId); };

            return (
                <div className="flex flex-col h-full">
                    <div className="mb-4"><label className="block text-sm font-bold text-gray-700 mb-1">目標車輛 (更換車輛將一併更新位置)</label><select className="w-full border rounded p-2 bg-white" value={targetCartId} onChange={e => setTargetCartId(e.target.value)}>{carts.map(c => <option key={c.id} value={c.id}>{c.id} 車 ({c.location})</option>)}</select></div>
                    <div className="mb-2 text-sm text-gray-600 bg-yellow-50 p-2 rounded"><i data-lucide="alert-triangle" className="w-3 h-3 inline mr-1"></i>您正在進行強制調度。修改後將立即生效。<br/>若為長期預約，將更新整學期該時段的分配。</div>
                    <div className="grid grid-cols-6 sm:grid-cols-6 gap-2 mb-4 overflow-y-auto max-h-[60vh] p-1">
                        {ALL_DEVICES.map(n => {
                            const isSelected = selected.has(n);
                            const info = statusMap[n] || { status: 'free' };
                            let style = "bg-white border-gray-200 text-gray-500 hover:bg-gray-50"; 
                            if (isSelected) style = "bg-green-500 text-white border-green-600 ring-2 ring-green-300";
                            else if (info.status === 'busy') style = "bg-blue-100 text-blue-400 border-blue-200 opacity-60";
                            else if (info.status === 'locked') style = "bg-red-100 text-red-400 border-red-200 opacity-60";
                            return (<button key={n} onClick={() => toggle(n)} className={`h-10 rounded border font-bold text-sm transition relative ${style}`}>{n}{isSelected && (<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="absolute top-0.5 right-0.5 w-3 h-3"><polyline points="20 6 9 17 4 12"></polyline></svg>)}</button>);
                        })}
                    </div>
                     <div className="mt-auto flex justify-between items-center border-t pt-3"><div className="text-sm font-bold text-blue-600">已選: {selected.size} 台</div><div className="flex gap-2"><button onClick={onClose} className="px-3 py-1.5 bg-gray-200 rounded hover:bg-gray-300 text-sm">取消</button><button onClick={handleSave} className="px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">儲存變更</button></div></div>
                </div>
            );
        }

        // Daily Report Modal
        function DailyReportModal({ bookings, onClose }) {
            const [reportDate, setReportDate] = React.useState(formatDate(new Date()));
            const generateReport = () => {
                const targetDay = getDayOfWeek(reportDate);
                const list = bookings.filter(b => { if (b.status === 'cancelled') return false; if (b.type === 'long-term') { return parseInt(b.dayOfWeek) === targetDay && (!b.startDate || (reportDate >= b.startDate && reportDate <= b.endDate)); } else { return b.date === reportDate; } });
                const carts = {}; list.forEach(b => { if (!carts[b.cartId]) carts[b.cartId] = []; carts[b.cartId].push(b); });
                let text = `【${reportDate} (週${DAY_LABELS[targetDay]}) 平板出借清單】\n`; if (Object.keys(carts).length === 0) text += "今日無預約資料。\n";
                Object.keys(carts).sort().forEach(cartId => {
                    text += `\n［${cartId}車］\n`;
                    const cartBookings = carts[cartId];
                    const groups = {};
                    cartBookings.forEach(b => { const deviceStr = formatDeviceList(b.deviceIds); const key = `${b.user}_${b.ext}_${deviceStr}`; if (!groups[key]) groups[key] = { user: b.user, ext: b.ext, devices: deviceStr, periods: [] }; groups[key].periods.push(b.period); });
                    const sortedGroups = Object.values(groups).sort((a,b) => Math.min(...a.periods) - Math.min(...b.periods));
                    sortedGroups.forEach((g, index) => { const periods = [...new Set(g.periods)].sort((a,b)=>a-b).join('、'); text += `${index + 1}.借用人: ${g.user} (分機${g.ext})：第 ${periods} 節\n`; text += `  編號: ${g.devices}\n`; });
                });
                return text;
            };
            const text = generateReport();
            const copyToClipboard = () => { navigator.clipboard.writeText(text); alert("已複製到剪貼簿"); };
            return (
                <div className="flex flex-col h-full"><div className="mb-4 flex items-center gap-2"><label className="font-bold">報表日期：</label><input type="date" value={reportDate} onChange={e => setReportDate(e.target.value)} className="border rounded px-2 py-1" /></div><textarea readOnly className="flex-grow w-full border rounded p-3 font-mono text-sm bg-gray-50 h-64 mb-4" value={text}></textarea><div className="flex justify-end gap-2"><button onClick={onClose} className="px-4 py-2 bg-gray-200 rounded text-gray-700">關閉</button><button onClick={copyToClipboard} className="px-4 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">複製內容</button></div></div>
            );
        }

        function MaintenanceGrid({ cartId, initialIds, onClose, db, appId, showToast }) {
            const [selected, setSelected] = React.useState(new Set(initialIds));
            const toggle = (id) => { const next = new Set(selected); if (next.has(id)) next.delete(id); else next.add(id); setSelected(next); };
            const save = async () => { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'cart_status', cartId), { brokenIds: Array.from(selected).sort((a,b)=>a-b), updatedAt: serverTimestamp() }); showToast(`已更新 ${cartId} 車鎖定狀態`); onClose(); };
            return (
                <div><p className="text-sm text-gray-500 mb-4">請點選 <span className="text-red-500 font-bold">鎖定中/不可借</span> 的號碼。</p><div className="grid grid-cols-6 gap-2 mb-6">{ALL_DEVICES.map(n => (<button key={n} onClick={() => toggle(n)} className={`h-10 rounded border font-bold transition ${selected.has(n) ? 'bg-red-500 text-white border-red-600' : 'bg-white text-gray-600 hover:bg-gray-100'}`}>{n}</button>))}</div><div className="flex justify-end gap-2"><button onClick={onClose} className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">取消</button><button onClick={save} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">儲存設定</button></div></div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

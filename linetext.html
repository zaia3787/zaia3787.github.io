<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE å°è©±åˆ†æå„€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif; background-color: #f8fafc; color: #334155; }
        
        /* Message Styles */
        .message-row { border-bottom: 1px solid #f1f5f9; padding: 6px 0; display: flex; align-items: flex-start; font-size: 0.85rem; }
        .message-time { color: #94a3b8; font-size: 0.8em; min-width: 55px; margin-top: 2px; }
        .message-content { flex-grow: 1; margin-left: 8px; line-height: 1.5; word-break: break-all; }
        
        /* Highlight Styles */
        .highlight-self { background-color: #dbeafe; color: #1e40af; border-radius: 2px; padding: 0 2px; }
        .highlight-cog { background-color: #ffedd5; color: #9a3412; border-radius: 2px; padding: 0 2px; }
        .highlight-hedge { background-color: #f3e8ff; color: #6b21a8; border-radius: 2px; padding: 0 2px; }
        .highlight-pos { background-color: #dcfce7; color: #166534; border-radius: 2px; padding: 0 2px; font-weight: bold;}
        .highlight-neg { background-color: #fee2e2; color: #991b1b; border-radius: 2px; padding: 0 2px; font-weight: bold;}
        .highlight-dirty { background-color: #e2e8f0; color: #ef4444; border-radius: 2px; padding: 0 2px; font-weight: bold; border: 1px solid #cbd5e1; } 
        .highlight-sticker { color: #15803d; font-weight: bold; font-size: 0.85em; background: #f0fdf4; padding: 1px 4px; border-radius: 4px; border: 1px solid #bbf7d0;}
        .highlight-share { color: #0284c7; text-decoration: underline; background-color: #e0f2fe; padding: 0 2px; border-radius: 2px; font-weight: bold; }
        .highlight-tilde { color: #db2777; font-weight: bold; }

        /* Compact Stat Card */
        .stat-card { background: white; border-radius: 12px; padding: 8px 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; display: flex; flex-direction: column; justify-content: center; height: 75px; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); border-color: #cbd5e1; }
        .stat-title { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .stat-value { font-size: 1.4rem; font-weight: 800; color: #1e293b; line-height: 1.1; }
        .stat-trend { font-size: 0.7rem; font-weight: 600; margin-left: 6px; padding: 1px 5px; border-radius: 9999px; }

        /* Persona Card */
        .persona-card { background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%); color: white; transition: background 0.5s ease; }
        .persona-icons-container { display: flex; gap: 8px; justify-content: center; align-items: center; margin-bottom: 0.5rem; height: 60px; }
        .persona-icon-main { font-size: 3.5rem; text-shadow: 0 4px 6px rgba(0,0,0,0.2); animation: float 3s ease-in-out infinite; z-index: 10; }
        .persona-icon-sub { font-size: 2rem; text-shadow: 0 4px 6px rgba(0,0,0,0.1); opacity: 0.7; filter: grayscale(30%); animation: floatDelayed 4s ease-in-out infinite; }
        
        /* Overall Persona Card */
        .overall-card { background: linear-gradient(135deg, #0f172a 0%, #334155 100%); color: white; }

        /* Spectrum Bar */
        .spectrum-container { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 12px; scroll-behavior: smooth; }
        .spectrum-container::-webkit-scrollbar { height: 6px; }
        .spectrum-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .spectrum-item { 
            flex: 0 0 auto; 
            width: 110px; 
            background: white; 
            border-radius: 12px; 
            padding: 10px; 
            border: 1px solid #e2e8f0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            text-align: center;
            transition: all 0.2s;
        }
        .spectrum-item:hover { transform: translateY(-3px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-color: #6366f1; }
        .spec-icon { font-size: 1.8rem; margin-bottom: 4px; }
        .spec-name { font-size: 0.75rem; font-weight: 700; color: #475569; margin-bottom: 6px; line-height: 1.2; height: 2.4em; display: flex; align-items: center; justify-content: center; }
        .spec-bar-bg { width: 100%; height: 6px; background: #f1f5f9; border-radius: 3px; overflow: hidden; }
        .spec-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease-out; }
        .spec-val { font-size: 0.7rem; color: #94a3b8; margin-top: 4px; font-weight: 600; }

        /* Daily Persona Grid */
        .daily-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); 
            gap: 6px; 
            padding: 4px;
        }
        .daily-item { 
            background: white; 
            border-radius: 8px; 
            border: 1px solid #e2e8f0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            aspect-ratio: 1; 
            cursor: pointer; 
            transition: all 0.15s; 
        }
        .daily-item:hover { transform: scale(1.15); z-index: 20; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-color: #94a3b8; }
        .daily-date { font-size: 0.6rem; color: #64748b; font-weight: 700; margin-bottom: 2px; }
        .daily-emoji { font-size: 1.4rem; line-height: 1; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1)); }

        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
        @keyframes floatDelayed { 0% { transform: translateY(-3px); } 50% { transform: translateY(2px); } 100% { transform: translateY(-3px); } }
        
        .modal { transition: opacity 0.3s ease-in-out; }
        .modal-content { max-height: 80vh; overflow-y: auto; }
        .low-data-day { opacity: 0.6; background-color: #f8fafc; border-left: 3px solid #cbd5e1; padding-left: 8px; }
        
        /* New Tab Styles */
        .tab-btn { 
            flex: 1; 
            padding: 16px; 
            border-radius: 12px; 
            font-weight: 800; 
            font-size: 1.1rem; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.2s; 
            border: 2px solid #e2e8f0; 
            color: #94a3b8;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .tab-btn:hover { background: #f8fafc; border-color: #cbd5e1; color: #475569; }
        .tab-btn.active { 
            background: linear-gradient(to right, #4f46e5, #4338ca); 
            border-color: transparent; 
            color: white; 
            box-shadow: 0 4px 6px -1px rgba(67, 56, 202, 0.3);
            transform: translateY(-1px);
        }
        .chart-container { position: relative; height: 450px; width: 100%; }
        
        .tendency-badge { 
            background: rgba(255,255,255,0.25); 
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.4);
            border-radius: 9999px;
            padding: 4px 14px;
            font-size: 0.8rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }

        /* Validity Banner */
        .validity-banner {
            font-size: 0.8rem;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 0px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .validity-high { background-color: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }
        .validity-med { background-color: #fffbeb; color: #b45309; border: 1px solid #fde68a; }
        .validity-low { background-color: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }
    </style>
</head>
<body class="p-4 md:p-6 min-h-screen flex flex-col bg-slate-50">

<div class="max-w-7xl mx-auto w-full space-y-5 flex-grow">
    <!-- Header -->
    <header class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <h1 class="text-2xl font-bold text-slate-800 tracking-tight flex items-center gap-2">
                LINE å°è©±åˆ†æå„€ 
                <span class="text-[10px] bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full font-bold uppercase">v5.2 iOS Fixed</span>
            </h1>
            <p class="text-slate-500 text-sm mt-1">å…¨æ–¹ä½å¿ƒç†èªè¨€åˆ†æï¼šæ”¯æ´ iOS/PC åŒ¯å‡ºæ ¼å¼ + ä¿¡æ•ˆåº¦æª¢æ ¸ã€‚</p>
        </div>
        <div class="flex gap-3">
             <label for="fileInput" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl cursor-pointer transition shadow-md shadow-indigo-200 text-sm font-bold flex items-center gap-2 hover:scale-105 active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                åŒ¯å…¥èŠå¤©ç´€éŒ„ (.txt)
            </label>
            <input type="file" id="fileInput" accept=".txt" class="hidden">
        </div>
    </header>

    <!-- Validity Banner (Placed below Title) -->
    <div id="validityBanner" class="validity-banner hidden">
        <!-- JS will populate this -->
    </div>

    <!-- Controls Row (Hidden initially) -->
    <div id="controls" class="hidden bg-white p-4 rounded-2xl shadow-sm border border-slate-200 grid grid-cols-2 md:grid-cols-4 gap-4">
        <div>
            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">åˆ†æå°è±¡</label>
            <select id="speakerSelect" class="w-full bg-slate-50 border-slate-200 rounded-lg border p-2 text-sm outline-none text-slate-700 font-medium cursor-pointer hover:bg-white transition"></select>
        </div>
        <div>
            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">é¸æ“‡å€é–“</label>
            <select id="monthSelect" class="w-full bg-slate-50 border-slate-200 rounded-lg border p-2 text-sm outline-none text-slate-700 font-medium cursor-pointer hover:bg-white transition"></select>
        </div>
        <div class="flex items-end pb-1 md:col-span-2">
             <div id="monthStatus" class="hidden text-xs text-amber-700 font-bold flex items-center gap-1.5 bg-amber-100 px-3 py-2 rounded-lg border border-amber-200 w-full md:w-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                ç•¶å‰æœˆä»½è³‡æ–™æœªå®Œçµï¼Œé‹ç®—ä¸å…·çµ±è¨ˆæ„ç¾©
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div id="navTabs" class="hidden flex gap-4">
        <button onclick="switchTab('persona')" id="tabPersona" class="tab-btn active">
            <span class="text-2xl">ğŸ­</span> 
            <div class="flex flex-col items-start">
                <span>è§’è‰²è¨ºæ–·</span>
                <span class="text-[10px] font-normal opacity-80">å¿ƒç†å´å¯«èˆ‡å…‰è­œ</span>
            </div>
        </button>
        <button onclick="switchTab('chart')" id="tabChart" class="tab-btn">
            <span class="text-2xl">ğŸ“ˆ</span> 
            <div class="flex flex-col items-start">
                <span>åœ–è¡¨çµ±è¨ˆ</span>
                <span class="text-[10px] font-normal opacity-80">æ¯æ—¥è¶¨å‹¢èˆ‡è©³æƒ…</span>
            </div>
        </button>
    </div>

    <!-- View 1: Persona Diagnosis -->
    <div id="viewPersona" class="hidden space-y-5">
        
        <!-- Compact Metrics Row -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
            <div class="stat-card border-l-4 border-l-blue-400">
                <div class="stat-title text-blue-500">è‡ªæˆ‘æ“æŠ±åº¦</div>
                <div class="flex items-baseline">
                    <div id="statSelf" class="stat-value">-</div>
                    <div class="text-[10px] text-slate-400 ml-1">%</div>
                    <div id="trendSelf" class="stat-trend bg-slate-100 text-slate-500">-</div>
                </div>
            </div>
            <div class="stat-card border-l-4 border-l-orange-400">
                <div class="stat-title text-orange-500">èªçŸ¥éè¼‰</div>
                <div class="flex items-baseline">
                    <div id="statCog" class="stat-value">-</div>
                    <div class="text-[10px] text-slate-400 ml-1">%</div>
                    <div id="trendCog" class="stat-trend bg-slate-100 text-slate-500">-</div>
                </div>
            </div>
            <div class="stat-card border-l-4 border-l-purple-400">
                <div class="stat-title text-purple-500">èªæ°£çŒ¶è±«åº¦</div>
                <div class="flex items-baseline">
                    <div id="statHedge" class="stat-value">-</div>
                    <div class="text-[10px] text-slate-400 ml-1">%</div>
                    <div id="trendHedge" class="stat-trend bg-slate-100 text-slate-500">-</div>
                </div>
            </div>
            <div class="stat-card border-l-4 border-l-green-500 bg-green-50/30">
                <div class="stat-title text-green-600">å¿«æ¨‚ä¸‰è§’ (æ ¡æ­£)</div>
                <div class="flex items-baseline">
                    <div id="statHappy" class="stat-value">-</div>
                    <div id="trendHappy" class="stat-trend bg-slate-100 text-slate-500">-</div>
                </div>
            </div>
            <div class="stat-card border-l-4 border-l-cyan-500 bg-cyan-50/30">
                <div class="stat-title text-cyan-600">ç¶œåˆåˆ†äº«æ…¾</div>
                <div class="flex items-baseline">
                    <div id="statShare" class="stat-value">-</div>
                    <div id="trendShare" class="stat-trend bg-slate-100 text-slate-500">-</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-12 gap-5">
            <!-- Main Persona Card (Composite) -->
            <div class="md:col-span-5 persona-card p-6 rounded-2xl shadow-xl flex flex-col justify-center items-center text-center relative overflow-hidden group min-h-[320px]">
                <div class="absolute top-0 left-0 w-full h-full bg-white/5 group-hover:bg-white/10 transition-colors"></div>
                <div class="relative z-10 flex flex-col items-center w-full">
                    <div class="text-[10px] uppercase font-bold tracking-[0.2em] text-white/70 mb-4 border-b border-white/20 pb-1">MONTHLY COMPOSITE</div>
                    
                    <!-- Composite Icons -->
                    <div id="personaIcons" class="persona-icons-container">
                        <span id="pIcon2" class="persona-icon-sub hidden">ğŸ¨</span>
                        <span id="pIcon1" class="persona-icon-main">ğŸ‘»</span>
                        <span id="pIcon3" class="persona-icon-sub hidden">â˜•ï¸</span>
                    </div>

                    <h2 id="personaTitle" class="text-3xl font-bold tracking-tight text-white mb-2">ç­‰å¾…åˆ†æ</h2>
                    
                    <div id="personaTag" class="text-xs text-white/90 font-medium mb-4 opacity-90 bg-white/20 px-3 py-1 rounded-full"></div>
                    
                    <div id="personaScore" class="tendency-badge hidden mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                        ä½”æ¯”ï¼š<span id="scoreVal">0</span>%
                    </div>

                    <p id="personaDesc" class="text-sm text-white/90 leading-relaxed px-4 opacity-90 font-medium">
                        è«‹åŒ¯å…¥ LINE èŠå¤©ç´€éŒ„
                    </p>
                </div>
            </div>

            <!-- Overall Persona Card (Historical) -->
            <div class="md:col-span-4 overall-card p-6 rounded-2xl shadow-xl flex flex-col justify-center items-center text-center relative overflow-hidden group min-h-[320px]">
                <div class="absolute top-0 left-0 w-full h-full bg-white/5 group-hover:bg-white/10 transition-colors"></div>
                <div class="relative z-10 flex flex-col items-center w-full">
                    <div class="text-[10px] uppercase font-bold tracking-[0.2em] text-white/60 mb-4 border-b border-white/10 pb-1">HISTORICAL DOMINANT</div>
                    <div id="histIcon" class="persona-icon mb-3" style="font-size: 2.5rem;">â™¾ï¸</div>
                    <h2 id="histTitle" class="text-2xl font-bold tracking-tight text-white mb-2">æ­·å²ç¸½å®šèª¿</h2>
                    <div class="text-[10px] bg-white/10 px-2 py-0.5 rounded text-white/80 mb-4">ç´¯ç©å¤§æ•¸æ“šåˆ†æ</div>
                    <p id="histDesc" class="text-sm text-white/80 leading-relaxed px-4 font-medium">
                        æ ¹æ“šæ‰€æœ‰æ­·å²ç´€éŒ„ï¼Œåˆ†ææ•´é«”çš„å¿ƒç†å‚¾å‘ã€‚
                    </p>
                </div>
            </div>

            <div class="md:col-span-3 flex flex-col gap-5">
                <!-- Insight Text Box -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="text-xs font-bold text-slate-800 mb-3 uppercase tracking-wide flex items-center gap-2 border-b border-slate-100 pb-2">
                        <span class="bg-indigo-100 text-indigo-600 p-1.5 rounded-md">ğŸ“Š</span> äº¤å‰åˆ†æå´å¯«
                    </h3>
                    <div id="monthSummary" class="text-sm text-slate-600 leading-relaxed space-y-2">
                        ç­‰å¾…è³‡æ–™åŒ¯å…¥...
                    </div>
                </div>

                <!-- Spectrum List -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 flex-grow flex flex-col">
                    <h3 class="text-xs font-bold text-slate-800 mb-3 uppercase tracking-wide flex items-center gap-2">
                        <span class="bg-pink-100 text-pink-600 p-1.5 rounded-md">ğŸŒˆ</span> ç•¶æœˆè§’è‰²å…‰è­œ
                    </h3>
                    <div id="spectrumList" class="spectrum-container flex-grow items-center px-1">
                        <div class="text-xs text-slate-400 italic w-full text-center py-4">ç­‰å¾…æ•¸æ“š...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW: Daily Persona Landscape -->
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
            <h3 class="text-xs font-bold text-slate-800 mb-4 uppercase tracking-wide flex items-center gap-2 border-b border-slate-100 pb-2">
                <span class="bg-amber-100 text-amber-600 p-1.5 rounded-md">ğŸ“…</span> æ¯æ—¥å¿ƒç†æ°£è±¡ (Daily Mood Landscape)
            </h3>
            <div id="dailyPersonaContainer" class="daily-grid w-full">
                <div class="text-xs text-slate-400 italic w-full text-center py-4">ç­‰å¾…æ•¸æ“šç”Ÿæˆæ—¥æ›†...</div>
            </div>
        </div>

    </div>

    <!-- View 2: Chart Statistics -->
    <div id="viewChart" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-5">
        <div class="lg:col-span-2 bg-white p-5 rounded-2xl shadow-sm border border-slate-200 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-sm font-bold text-slate-700">æ¯æ—¥å¿ƒç†èˆ‡è¡Œç‚ºè¶¨å‹¢åœ–</h3>
                <div class="text-[10px] text-slate-500 bg-slate-100 px-3 py-1.5 rounded-full font-medium">ğŸ’¡ é»æ“Šåœ–ä¾‹å¯é–‹é—œæ›²ç·š</div>
            </div>
            <div class="chart-container flex-grow">
                <canvas id="mainChart"></canvas>
            </div>
        </div>
        
        <!-- Detail List -->
        <div class="bg-white p-0 rounded-2xl shadow-sm border border-slate-200 flex flex-col h-[500px] overflow-hidden">
            <div class="p-4 border-b border-slate-100 bg-slate-50">
                <h3 class="font-bold text-slate-700 flex justify-between items-center text-sm">
                    <span id="detailDate">è«‹é¸æ“‡æ—¥æœŸ</span>
                    <span id="detailMood" class="text-[10px] px-2 py-1 rounded-full bg-slate-200 text-slate-500">-</span>
                </h3>
                <div id="detailStats" class="text-[10px] text-slate-400 mt-1"></div>
            </div>
            <div id="detailList" class="flex-1 overflow-y-auto p-4 space-y-3 bg-white scroll-smooth">
                <div class="text-slate-400 text-center mt-20 text-xs flex flex-col items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" /></svg>
                    é»æ“Šå·¦å´åœ–è¡¨æª¢è¦–è©³ç´°å°è©±
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-6 py-4 text-center border-t border-slate-200 flex flex-col items-center gap-2">
        <div id="dictSource" class="text-[10px] text-slate-400 font-bold tracking-wide">
            è³‡æ–™ä¾†æºï¼šåˆå§‹åŒ–...
        </div>
        <button onclick="toggleModal('infoModal')" class="text-indigo-500 hover:text-indigo-600 font-medium underline decoration-indigo-200 hover:decoration-indigo-500 transition-all text-xs">
            äº†è§£ 10 ç¨®è§’è‰²å¡èˆ‡ä½”æ¯”è¨ˆç®—å…¬å¼
        </button>
    </footer>
</div>

<!-- Info Modal -->
<div id="infoModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" onclick="if(event.target === this) toggleModal('infoModal')">
    <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl modal-content transform transition-all">
        <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-2xl">
            <h2 class="text-lg font-bold text-slate-800">ğŸ“Š 10 å¤§å¿ƒç†è§’è‰²èˆ‡è¨ˆç®—å…¬å¼</h2>
            <button onclick="toggleModal('infoModal')" class="text-slate-400 hover:text-slate-600">âœ•</button>
        </div>
        <div class="p-6 space-y-6 text-slate-600 text-sm leading-relaxed overflow-y-auto max-h-[60vh]">
            
            <div class="bg-slate-50 p-4 rounded-lg border border-slate-100 text-xs mb-4 space-y-2">
                <h3 class="font-bold text-slate-700 text-base mb-2">ğŸ§® å°ˆæœ‰åè©è¨ˆç®—å…¬å¼</h3>
                <p><strong>1. è‡ªæˆ‘æ“æŠ±åº¦ (Self-References Density):</strong><br> `(ç¬¬ä¸€äººç¨±ä»£åè©æ•¸ / ç¸½å­—æ•¸) * 100`ã€‚åæ˜ è‡ªæˆ‘é—œæ³¨ç¨‹åº¦ã€‚</p>
                <p><strong>2. èªçŸ¥éè¼‰ (Cognitive Load Density):</strong><br> `(å› æœé‚è¼¯é€£æ¥è©æ•¸ / ç¸½å­—æ•¸) * 100`ã€‚åæ˜ å¤§è…¦è™•ç†è¤‡é›œè³‡è¨Šæˆ–åˆç†åŒ–çš„ç¨‹åº¦ã€‚</p>
                <p><strong>3. èªæ°£çŒ¶è±«åº¦ (Hedge Density):</strong><br> `(æ¨¡ç³Šèªè©æ•¸ / ç¸½å­—æ•¸) * 100`ã€‚åæ˜ è‡ªä¿¡å¿ƒèˆ‡ä¸ç¢ºå®šæ„Ÿã€‚</p>
                <p><strong>4. å¿«æ¨‚ä¸‰è§’æŒ‡æ•¸ (Happiness Triad):</strong><br> ç¶œåˆ `å¼·çƒˆæ­£é¢è©(x2) + ä¸€èˆ¬æ­£é¢è©(x1) - è² é¢è©(x1.5) + log(è²¼åœ–/é©šå˜†è™Ÿ)`ã€‚åæ˜ æƒ…ç·’æ•ˆåƒ¹èˆ‡å–šèµ·åº¦ã€‚</p>
                <p><strong>5. ç¶œåˆåˆ†äº«æ…¾ (Sharing Desire):</strong><br> `é€£çµ + åœ–ç‰‡ + å½±ç‰‡ + åˆ†äº«èªå¥` çš„ç¸½é »æ¬¡ã€‚åæ˜ ä¸»å‹•äº’å‹•æ„é¡˜ã€‚</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="border-l-4 border-orange-500 pl-3 py-1"><h3 class="font-bold text-orange-700">1. ğŸŒµ å—å‚·åˆºèŸ (é˜²è¡›)</h3><p class="text-xs">ç‰¹å¾µï¼šä½è‡ªæˆ‘ + é«˜èªçŸ¥ã€‚æ„Ÿåˆ°è¢«èª¤è§£ï¼Œç”¨é‚è¼¯ä¿è­·è‡ªå·±ã€‚</p></div>
                <div class="border-l-4 border-purple-500 pl-3 py-1"><h3 class="font-bold text-purple-700">2. ğŸ¨ ç„¦æ…®ç„¡å°¾ç†Š (ç„¦æ…®)</h3><p class="text-xs">ç‰¹å¾µï¼šé«˜è‡ªæˆ‘ + é«˜èªçŸ¥ + é«˜çŒ¶è±«ã€‚æ‚£å¾—æ‚£å¤±ï¼Œå…§å¿ƒæˆ²å¤šã€‚</p></div>
                <div class="border-l-4 border-cyan-500 pl-3 py-1"><h3 class="font-bold text-cyan-700">3. ğŸ­ è¨æ‹æ¼”å“¡ (æ±‚é—œæ³¨)</h3><p class="text-xs">ç‰¹å¾µï¼šé«˜åˆ†äº« + é«˜è‡ªæˆ‘ + ä½å¿«æ¨‚ã€‚è² èƒ½é‡å¼·ï¼Œæ¸´æœ›è¢«å®‰æ…°ã€‚</p></div>
                <div class="border-l-4 border-slate-500 pl-3 py-1"><h3 class="font-bold text-slate-700">4. ğŸ‘¨â€ğŸ« åš´è‚…æ•™æˆ (èªªæ•™)</h3><p class="text-xs">ç‰¹å¾µï¼šé«˜èªçŸ¥ + ä½çŒ¶è±«ã€‚èªæ°£å¼·ç¡¬è¬›é“ç†ï¼Œæƒ…æ„Ÿé€£çµå¼±ã€‚</p></div>
                <div class="border-l-4 border-green-500 pl-3 py-1"><h3 class="font-bold text-green-700">5. ğŸ’– éˆé­‚ä¼´ä¾¶ (å…±é³´)</h3><p class="text-xs">ç‰¹å¾µï¼šé«˜å¿«æ¨‚ + ä½èªçŸ¥ã€‚å°è©±ç›´è¦ºæµæš¢ï¼Œæœ€èˆ’æœçš„ç‹€æ…‹ã€‚</p></div>
                <div class="border-l-4 border-yellow-500 pl-3 py-1"><h3 class="font-bold text-yellow-700">6. ğŸ¦ è‡ªä¿¡ç…å­ (è‡ªä¿¡)</h3><p class="text-xs">ç‰¹å¾µï¼šé«˜è‡ªæˆ‘ + ä½çŒ¶è±«ã€‚è‡ªä¿¡çˆ†æ£šï¼Œè‡ªæˆ‘ä¸­å¿ƒï¼Œèªªè©±ç›´æ¥ã€‚</p></div>
                <div class="border-l-4 border-red-500 pl-3 py-1"><h3 class="font-bold text-red-700">7. ğŸŒ‹ å®£æ´©ç«å±± (æƒ…ç·’åŒ–)</h3><p class="text-xs">ç‰¹å¾µï¼šé«˜è‡ªæˆ‘ + ä½å¿«æ¨‚ã€‚éç†æ€§æŠ±æ€¨ï¼Œå–®ç´”ç™¼æ´©æƒ…ç·’ã€‚</p></div>
                <div class="border-l-4 border-blue-500 pl-3 py-1"><h3 class="font-bold text-blue-700">8. ğŸ¦‰ æ…é‡è²“é ­é·¹ (å®¢è§€)</h3><p class="text-xs">ç‰¹å¾µï¼šä½è‡ªæˆ‘ + é«˜èªçŸ¥ + é«˜çŒ¶è±«ã€‚éåº¦è¬¹æ…ï¼Œå®¢è§€åˆ†æã€‚</p></div>
                <div class="border-l-4 border-amber-500 pl-3 py-1"><h3 class="font-bold text-amber-600">9. ğŸŒ» æº«æš–å‘æ—¥è‘µ (æ”¯æŒ)</h3><p class="text-xs">ç‰¹å¾µï¼šä½è‡ªæˆ‘ + é«˜å¿«æ¨‚ + é«˜åˆ†äº«ã€‚ç„¦é»åœ¨ä»–äººï¼Œæ¨‚æ–¼åˆ†äº«ã€‚</p></div>
                <div class="border-l-4 border-gray-400 pl-3 py-1"><h3 class="font-bold text-gray-600">10. ğŸ§˜ éœè¬è§€å¯Ÿè€… (å†·æ·¡)</h3><p class="text-xs">ç‰¹å¾µï¼šä¸‰é …çš†ä½ã€‚æ•·è¡å›æ‡‰ï¼Œä¸æƒ³æŠ•å…¥å°è©±ã€‚</p></div>
            </div>
        </div>
        <div class="p-4 bg-slate-50 rounded-b-2xl border-t border-slate-100 text-right">
            <button onclick="toggleModal('infoModal')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium transition text-sm">é—œé–‰</button>
        </div>
    </div>
</div>

<script>
    // --- 1. DEFAULT DICTIONARY (Safety Fallback) ---
    const DEFAULT_DICT = {
        self: ['æˆ‘', 'æˆ‘å€‘', 'è‡ªå·±', 'æœ¬èº«', 'åœ¨ä¸‹', 'æœ¬äºº', 'è€å­', 'æœ¬å®®', 'æœ¬åº§', 'å’±', 'ä¿º', 'å¶', 'æˆ‘è‡ªå·±', 'æ‹åŒ—', 'å“‡', 'me', 'äººå®¶', 'æœ¬å°å§', 'æœ¬å°‘çˆº', 'å‹è³‡', 'çª©', 'æŒ–', 'å“‡å¥”éƒ', 'è¦–è§’', 'é€™é‚Š', 'å°å¼Ÿ', 'å°å¦¹', 'è€å¨˜', 'æœ¬å±±äºº', 'å“¥', 'å§', 'æ—åŒ—', 'æçˆ¸', 'æˆ‘å€‹äºº', 'å°æˆ‘ä¾†èªª', 'ä»¥æˆ‘', 'åœ¨æˆ‘çœ‹ä¾†', 'æˆ‘å€‘å®¶', 'å’±å€‘', 'å¾', 'ä½™', 'å­¤', 'å¯¡äºº', 'å¦¾èº«', 'å¥´å®¶', 'æ•äºº', 'é„™äºº', 'æœ«å­¸', 'ç­†è€…', 'ç‰ˆä¸»', 'åŸPO', 'æ¨“ä¸»'],
        cognitive: ['å› ç‚º', 'æ‰€ä»¥', 'ä½†æ˜¯', 'ä½†', 'ä¸é', 'å…¶å¯¦', 'é™¤äº†', 'å¦‚æœ', 'å°è‡´', 'ç‚ºäº†', 'åŸæœ¬', 'æ¥è‘—', 'ç„¶å¾Œ', 'çµæœ', 'é›–ç„¶', 'åè€Œ', 'ç©¶ç«Ÿ', 'æ„å‘³è‘—', 'é™¤é', 'åæ­£', 'ç•¢ç«Ÿ', 'é›£é“', 'ç¸½ä¹‹', 'åŸºæœ¬ä¸Š', 'é‘‘æ–¼', 'æ–¼æ˜¯', 'åªè¦', 'å› æ­¤', 'ç„¶è€Œ', 'å¦å‰‡', 'ä»¥ä¾¿', 'ä»¥è‡´', 'åŠ ä¸Š', 'åªæœ‰', 'ç”±æ–¼', 'ä»¥æ­¤', 'æˆ–æ˜¯', 'æˆ–è€…', 'ä¸¦ä¸”', 'è€Œä¸”', 'å›ºç„¶', 'ç¸±ä½¿', 'å³ä½¿', 'å‡å¦‚', 'å‡ä½¿', 'å€˜è‹¥', 'è¦æ˜¯', 'è¬ä¸€', 'æ¯”å¦‚', 'ä¾‹å¦‚', 'åƒæ˜¯', 'ä¹Ÿå°±æ˜¯èªª', 'æ›å¥è©±èªª', 'åä¹‹', 'ç”šè‡³', 'é¡¯ç„¶', 'åŸºæ–¼', 'èªç‚º', 'è¦ºå¾—', 'ç™¼ç¾', 'ç†è§£', 'æ˜ç™½', 'æ¨æ¸¬', 'ä¼°è¨ˆ', 'åˆ†æ', 'è€ƒæ…®', 'è¨ˆç•«', 'æ‰“ç®—'],
        hedge: ['å¯èƒ½', 'å¤§æ¦‚', 'æ‡‰è©²', 'æˆ–è¨±', 'æ„Ÿè¦º', 'å¥½åƒ', 'ä¼¼ä¹', 'ä¸ç¢ºå®š', 'é‚£å€‹', 'å—¯', 'ç®—æ˜¯', 'å‹‰å¼·', 'ç¨å¾®', 'å¤§ç´„', 'æ²’æº–', 'çœ‹æƒ…æ³', 'è½èªª', 'æ“šèªª', 'ä¸çŸ¥', 'æœ‰é»', 'å·®ä¸å¤š', 'å¯èƒ½æœƒ', 'æ‡‰è©²æ˜¯', 'æˆ–è€…æ˜¯', 'çœ‹æ¨£å­', 'æä¸å¥½', 'èªªä¸å®š', 'ææ€•', 'ä¾ç¨€', 'å½·å½¿', 'å¤§è‡´ä¸Š', 'åŸå‰‡ä¸Š', 'ç†è«–ä¸Š', 'æŸç¨®ç¨‹åº¦', 'ç›¸å°', 'æ¯”è¼ƒ', 'æœ‰é»å…’', 'ç•¥å¾®', 'å¤šå°‘', 'æˆ–æ˜¯èªª', 'è©±èªª', 'å‘ƒ', 'ç—¾', 'é‚£å€‹...', 'å—¯...', 'æ‡‰è©²å§', 'å¥½åƒæ˜¯', 'è²Œä¼¼', 'ç–‘ä¼¼', 'æˆ–è¨±å§'],
        pos_strong: ['å“ˆå“ˆå“ˆ', 'ç¬‘æ­»', 'ç¬‘çˆ›', 'å¤ªæ£’', 'çˆ½', 'æ„›æ­»', 'è¶…å¥½', 'å®Œç¾', 'ç¥', 'å„ªç§€', 'å˜»å˜»', 'å˜¿å˜¿', 'XD', 'XDD', 'è®š', 'ç‰›é€¼', 'å¤ªç¥', 'å¥½ç¬‘', 'ç¬‘ç˜‹', 'www', 'XDDD', 'ç¬‘å™´', 'ç¬‘ç¿»', 'ç¬‘æ…˜', 'å¥½çˆ½', 'è¶…çˆ½', 'å¤ªçˆ½', 'çˆ½å•¦', 'çˆ½æ­»', 'æ„›äº†', 'è¶…æ„›', 'å¤ªæ„›', 'çµ•äº†', 'å²å®³', 'å¤ªå¼·', 'è¶…å¼·', 'å¥½å¼·', 'çŒ›', 'è¶…çŒ›', 'å¤ªçŒ›', 'å±Œ', 'è¶…å±Œ', 'å¤ªå±Œ', 'æ£’å‘†', 'è®šçˆ†', 'æ¨çˆ†', 'ç¥ä½œ', 'å„ªè³ª', 'å´‡æ‹œ', 'æ°´å•¦', 'æ°´å–”', '666', 'ç¬‘é¼ ', 'ç¬‘åˆ°è‚šå­ç—›', 'å“ˆå›‰', 'é–‹å¿ƒæ­»', 'å¿«æ¨‚æ­»', 'èˆˆå¥®', 'ç‹‚', 'è¶…ç‹‚'],
        pos_normal: ['é–‹å¿ƒ', 'å¿«æ¨‚', 'å–œæ­¡', 'ä¸éŒ¯', 'å¥½', 'æ„Ÿè¬', 'è¬è¬', 'èˆ’æœ', 'å®‰å¿ƒ', 'æœŸå¾…', 'å¸Œæœ›', 'å¹¸é‹', 'æ­è€¶', 'good', 'nice', 'ok', 'OK', 'æ£’', 'å¹¸ç¦', 'æ»¿è¶³', 'é †åˆ©', 'è¼•é¬†', 'æ”¾é¬†', 'ç™‚ç™’', 'æº«æš–', 'æ„Ÿå‹•', 'å¯ä»¥', 'æ²’å•é¡Œ', 'æ²’äº‹', 'ä¸è³´', 'å¥½å–”', 'å¥½æ»´', 'å¥½å™ ', 'è¾›è‹¦äº†', 'ç”˜æº«', 'å¤šè¬', 'é˜¿é‡Œå˜å¤š', 'æ„Ÿæ©', 'æ¬£æ…°', 'æ¨‚æ„', 'äº«å—', 'ç¾æ»¿', 'ç”œèœœ', 'æº«é¦¨', 'å¥½åº·', 'å¹¸é‹', 'å¥½é‹', 'ç¥ç¦', 'æ­å–œ'],
        neg: ['è¨å­', 'ç…©', 'æ¨', 'ä¸çˆ½', 'é›£é', 'å‚·å¿ƒ', 'ç´¯', 'ç—›', 'æ°£', 'æ»¾', 'ç³Ÿ', 'çˆ›', 'å“­', 'ç”šè‡³', 'ç„¡è¨€', 'å‚»çœ¼', 'ç…©èº', 'æ“”å¿ƒ', 'å®³æ€•', 'ç„¦æ…®', 'ç”Ÿæ°£', 'å¹¹å˜›', 'å•è™Ÿ', '...', 'ç—›è‹¦', 'æ‚²å‚·', 'æ†‚é¬±', 'é¬±å’', 'ç„¡å¥ˆ', 'ç„¡åŠ›', 'ç–²æ†Š', 'å¿ƒç´¯', 'å¿ƒç¢', 'çµ•æœ›', 'å¤±æœ›', 'ç°å¿ƒ', 'å—å‚·', 'å§”å±ˆ', 'å€’éœ‰', 'è¡°', 'é›–å°', 'è³­çˆ›', 'åŒ—å®‹', 'ä¸é–‹å¿ƒ', 'ä¸å¿«æ¨‚', 'ä¸èˆ’æœ', 'ä¸å®‰', 'ç·Šå¼µ', 'å£“åŠ›', 'æ²ˆé‡', 'æ²ˆæ‚¶', 'å°·å°¬', 'ä¸Ÿè‡‰', 'ç¾æ¥', 'å¾Œæ‚”', 'éºæ†¾', 'å¯æƒœ', 'å®Œè›‹', 'æ­»å®š', 'æ…˜', 'æ…˜äº†', 'ç³Ÿç³•', 'å´©æ½°', 'çœ¼ç¥æ­»'],
        dirty: ['å¹¹', 'é ', 'åª½çš„', 'ä¸‰å°', 'ç™½ç—´', 'æ™ºéšœ', 'åŒ—ä¸ƒ', 'é æ¯', 'é åŒ—', 'ä¹¾', 'æ“', 'æ©Ÿæ°', 'é›æ°', 'ä»–åª½', 'å»æ­»', 'åƒåœ¾', 'å»¢ç‰©', 'ç™½ç›®', 'è…¦æ®˜', 'ç¥ç¶“', 'Xçš„', 'TMD', 'WTF', 'shit', 'fucking', 'fuck', 'æ©Ÿè»Š', 'GY', 'é›æ­ª', 'é é‚€', 'é è…°', 'å“­çˆ¸', 'å“­å¤­', 'æ—è€å¸«', 'ä½ å¨˜', 'è€æœ¨', 'è‰ææ“º', 'è¶•ç¾šç¾Š', 'åª½å’§', 'åŒ—çˆ›', '78', '87', 'ç ´éº»', 'å©Šå­', 'æ™ºç¼º', 'ä½èƒ½', 'å•Ÿæ™º', 'è…¦æ³¢å¼±', 'æœ‰ç—…', 'ç¥ç¶“ç—…', 'è•­å©†', 'ç˜‹å­'],
        share_phrases: ['ä½ çœ‹', 'å¿«çœ‹', 'æ¨è–¦', 'é€™å®¶', 'é€™å€‹å¥½', 'åˆ†äº«', 'é€£çµ', 'ç¶²å€', 'å»åƒ', 'å»ç©', 'è½èªªé€™', 'é€™é–“', 'é€™é¦–', 'é€™éƒ¨', 'é€™è£¡', 'é‚£è£¡', 'é€£çµ', 'link', 'URL', 'http', 'IG', 'instagram', 'youtube', 'yt', 'é–‹ç®±', 'é£Ÿè¨˜', 'éŠè¨˜', 'æ”»ç•¥', 'æƒ…å ±', 'å„ªæƒ ', 'ç‰¹åƒ¹', 'åœ˜è³¼', 'å¿…åƒ', 'å¿…å»', 'å¿…è²·', 'å¥½ç‰©', 'å®‰åˆ©', 'æ¨å‘', 'å‚³çµ¦', 'è½‰ç™¼']
    };

    // Initialize with default immediately
    let DICT = JSON.parse(JSON.stringify(DEFAULT_DICT));

    // Try to fetch external (Fail-Safe)
    const sourceEl = document.getElementById('dictSource');
    
    fetch('https://zaia3787.github.io/dict.json')
        .then(r => {
            if (r.ok) return r.json();
            throw new Error('Network response was not ok.');
        })
        .then(json => {
            DICT = { ...DEFAULT_DICT, ...json }; 
            sourceEl.innerHTML = 'ğŸŸ¢ è³‡æ–™ä¾†æºï¼šå¤–éƒ¨æ“´å……å­—å…¸ (GitHub)';
            sourceEl.className = 'text-[10px] text-green-600 font-bold tracking-wide';
            console.log("å¤–éƒ¨å­—å…¸è¼‰å…¥æˆåŠŸ");
        })
        .catch(e => {
            console.warn("å¤–éƒ¨å­—å…¸è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨å…§å»ºé è¨­å€¼:", e);
            sourceEl.innerHTML = 'ğŸŸ  è³‡æ–™ä¾†æºï¼šå…§å»ºå®‰å…¨å­—å…¸ (Fail-Safe)';
            sourceEl.className = 'text-[10px] text-orange-500 font-bold tracking-wide';
        });

    const PERSONAS = [
        { id: 'hedgehog', name: 'å—å‚·åˆºèŸ', icon: 'ğŸŒµ', desc: 'é˜²è¡›å¿ƒå¼·ä¸”æ•æ„Ÿ', color: '#f97316', bg: '#fff7ed' },
        { id: 'koala', name: 'ç„¦æ…®ç„¡å°¾ç†Š', icon: 'ğŸ¨', desc: 'æ‚£å¾—æ‚£å¤±', color: '#a855f7', bg: '#faf5ff' },
        { id: 'actor', name: 'è¨æ‹æ¼”å“¡', icon: 'ğŸ­', desc: 'æ¸´æœ›è¢«çœ‹è¦‹èˆ‡å®‰æ…°', color: '#06b6d4', bg: '#ecfeff' },
        { id: 'prof', name: 'åš´è‚…æ•™æˆ', icon: 'ğŸ‘¨â€ğŸ«', desc: 'èªæ°£å¼·ç¡¬ï¼Œå‚¾å‘è¬›é“ç†', color: '#475569', bg: '#f1f5f9' },
        { id: 'soulmate', name: 'éˆé­‚ä¼´ä¾¶', icon: 'ğŸ’–', desc: 'äº’å‹•ç›´è¦ºæµæš¢', color: '#ec4899', bg: '#fdf2f8' },
        { id: 'peacock', name: 'è‡ªä¿¡ç…å­', icon: 'ğŸ¦', desc: 'è‡ªä¿¡çˆ†æ£šï¼Œè‡ªæˆ‘ä¸­å¿ƒ', color: '#eab308', bg: '#fefce8' },
        { id: 'volcano', name: 'å®£æ´©ç«å±±', icon: 'ğŸŒ‹', desc: 'æƒ…ç·’èµ·ä¼è¼ƒå¤§', color: '#ef4444', bg: '#fef2f2' },
        { id: 'owl', name: 'æ…é‡è²“é ­é·¹', icon: 'ğŸ¦‰', desc: 'éåº¦è¬¹æ…ï¼Œå®¢è§€åˆ†æ', color: '#3b82f6', bg: '#eff6ff' },
        { id: 'sunflower', name: 'æº«æš–å‘æ—¥è‘µ', icon: 'ğŸŒ»', desc: 'æ¨‚æ–¼åˆ†äº«ï¼Œé—œå¿ƒä»–äºº', color: '#f59e0b', bg: '#fffbeb' },
        { id: 'robot', name: 'éœè¬è§€å¯Ÿè€…', icon: 'ğŸ§˜', desc: 'æƒ…ç·’å¹³ç©©ï¼Œè©±èªç°¡æ½”', color: '#94a3b8', bg: '#f8fafc' },
        { id: 'coffee', name: 'æ­²æœˆéœå¥½', icon: 'â˜•ï¸', desc: 'æƒ…ç·’å¹³ç©©ï¼Œæ—¥å¸¸å®‰ç©©', color: '#6366f1', bg: '#eef2ff' }
    ];

    let rawChatData = [];
    let processedData = {}; 
    let currentSpeaker = '';
    let currentMonth = '';
    let latestMonthInFile = ''; 
    let mainChartInstance = null;
    let activeTab = 'persona';

    document.getElementById('fileInput').addEventListener('change', handleFileSelect, false);

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) { 
            try {
                // Strip BOM
                const text = e.target.result.replace(/^\uFEFF/, '');
                parseLineText(text); 
            } catch (err) {
                console.error(err);
                alert("æª”æ¡ˆè®€å–ç™¼ç”ŸéŒ¯èª¤: " + err.message + "\nè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚");
            }
        };
        reader.readAsText(file);
    }

    function parseLineText(text) {
        const lines = text.split(/\r?\n/);
        rawChatData = [];
        let currentDate = '';
        
        // Robust Date Regex: 2025.10.06 or 2025/10/06 or 2025-10-06
        const dateRegex = /^\s*(\d{4})[./-](\d{1,2})[./-](\d{1,2})/;
        // Robust Msg Regex: Time Space Name Space Content
        const timeRegex = /^((?:ä¸Šåˆ|ä¸‹åˆ|AM|PM|am|pm)?\s?\d{1,2}:\d{2})/;
        const linkRegex = /(https?:\/\/[^\s]+)/g;

        lines.forEach(line => {
            line = line.trim();
            if (!line) return;

            const dateMatch = line.match(dateRegex);
            if (dateMatch) {
                const y = dateMatch[1];
                const m = dateMatch[2].padStart(2, '0');
                const d = dateMatch[3].padStart(2, '0');
                currentDate = `${y}/${m}/${d}`;
                return;
            }

            if (timeRegex.test(line) && currentDate) {
                // Find first whitespace -> time end
                const firstSpace = line.search(/\s/);
                if (firstSpace === -1) return;
                
                // For Tab Separated files (iOS), parts[0] might contain time.
                // But using spaces/tabs regex is safer.
                
                // Let's try splitting by tab first
                let parts = line.split('\t');
                let time, name, content;

                if (parts.length >= 3) {
                    time = parts[0].trim();
                    name = parts[1].trim();
                    content = parts.slice(2).join('\t').trim();
                } else {
                    // Fallback to space splitting
                    const t = line.substring(0, firstSpace);
                    const r = line.substring(firstSpace).trim();
                    const s2 = r.search(/\s/);
                    if (s2 === -1) return;
                    time = t;
                    name = r.substring(0, s2);
                    content = r.substring(s2).trim();
                }
                
                if (content.includes('å·²æ”¶å›è¨Šæ¯') || content.includes('é€šè©±æ™‚é–“') || content.includes('é‚€è«‹') || content.includes('åŠ å…¥èŠå¤©')) return;
                
                const isSticker = content.includes('è²¼åœ–') || content.includes('(sticker)') || content.includes('[è²¼åœ–]');
                const isImage = content.includes('åœ–ç‰‡') || content.includes('ç…§ç‰‡') || content.includes('[ç…§ç‰‡]');
                const isVideo = content.includes('å½±ç‰‡');
                const links = (content.match(linkRegex) || []).length;
                const exclamations = (content.match(/ï¼|!/g) || []).length;

                rawChatData.push({
                    date: currentDate,
                    month: currentDate.substring(0, 7), // YYYY/MM
                    time: time,
                    name: name,
                    content: content,
                    isSticker: isSticker,
                    isImage: isImage || isVideo,
                    linkCount: links,
                    exclamations: exclamations
                });
            }
        });

        if (rawChatData.length === 0) {
            alert("æœªåµæ¸¬åˆ°æœ‰æ•ˆå°è©±ç´€éŒ„ã€‚è«‹ç¢ºèªæª”æ¡ˆå…§å®¹åŒ…å«æ—¥æœŸèˆ‡å°è©±ã€‚");
            return;
        }
        processData();
    }

    function processData() {
        const speakers = [...new Set(rawChatData.map(d => d.name))];
        if (speakers.length === 0) return;
        
        const speakerCounts = {};
        rawChatData.forEach(d => { speakerCounts[d.name] = (speakerCounts[d.name] || 0) + 1; });
        const sortedSpeakers = Object.keys(speakerCounts).sort((a,b) => speakerCounts[b] - speakerCounts[a]);
        
        const spkSelect = document.getElementById('speakerSelect');
        spkSelect.innerHTML = '';
        sortedSpeakers.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s; opt.text = s; spkSelect.appendChild(opt);
        });
        currentSpeaker = sortedSpeakers[0];

        const allMonths = [...new Set(rawChatData.map(d => d.month))].sort();
        latestMonthInFile = allMonths[allMonths.length - 1];
        processedData = {};
        
        const safeIter = (arr, cb) => { if(Array.isArray(arr)) arr.forEach(cb); };

        speakers.forEach(speaker => {
            const msgs = rawChatData.filter(d => d.name === speaker);
            const daysMap = {};
            const monthSet = new Set();
            
            let totalWords = 0;
            let countPosStrong = 0;
            let totalTextMsgs = 0; 

            msgs.forEach(m => {
                monthSet.add(m.month);
                if (!daysMap[m.date]) {
                    daysMap[m.date] = {
                        date: m.date,
                        month: m.month,
                        msgs: [],
                        metrics: { 
                            wordCount: 0, self: 0, cog: 0, hedge: 0, 
                            sticker: 0, links: 0, media: 0, sharePhrase: 0, 
                            pos_strong: 0, pos_normal: 0, neg: 0, exclamations: 0, 
                            dirty_pure: 0, tilde: 0, hard_period: 0, burst_peak: 0 
                        },
                        burstMap: {},
                        isLowData: false 
                    };
                }
                const day = daysMap[m.date];
                day.msgs.push(m);
                day.burstMap[m.time] = (day.burstMap[m.time] || 0) + 1;

                if (m.isSticker) {
                    day.metrics.sticker++;
                } else {
                    if (m.isImage) {
                        day.metrics.media++;
                    } else {
                         if (!m.content.startsWith('http')) totalTextMsgs++;
                    }

                    day.metrics.wordCount += m.content.length;
                    totalWords += m.content.length; 
                    day.metrics.links += m.linkCount;
                    day.metrics.exclamations += m.exclamations;
                    
                    day.metrics.tilde += (m.content.match(/[~ï½ã€œ]/g) || []).length;
                    if (m.content.length < 10 && (m.content.endsWith('ã€‚') || m.content.endsWith('.'))) {
                         day.metrics.hard_period++;
                    }

                    safeIter(DICT.self, k => { if(m.content.includes(k)) day.metrics.self++; });
                    safeIter(DICT.cognitive, k => { if(m.content.includes(k)) day.metrics.cog++; });
                    safeIter(DICT.hedge, k => { if(m.content.includes(k)) day.metrics.hedge++; });
                    safeIter(DICT.pos_normal, k => { if(m.content.includes(k)) day.metrics.pos_normal++; });
                    safeIter(DICT.neg, k => { if(m.content.includes(k)) day.metrics.neg++; });
                    safeIter(DICT.share_phrases, k => { if(m.content.includes(k)) day.metrics.sharePhrase++; });
                    
                    let isDirty = false;
                    safeIter(DICT.dirty, k => { if(m.content.includes(k)) isDirty = true; });
                    let isFunny = false;
                    safeIter(DICT.pos_strong, k => { 
                        if(m.content.toLowerCase().includes(k.toLowerCase())) {
                            day.metrics.pos_strong++; 
                            countPosStrong++;
                            isFunny = true;
                        }
                    });
                    if (isDirty && !isFunny) day.metrics.dirty_pure++;
                }
            });

            const activeDaysCount = Object.keys(daysMap).length;
            const totalMessages = msgs.length;
            let dailyAvg = 0;

            if (activeDaysCount > 0) dailyAvg = totalMessages / activeDaysCount;
            const lowDataThreshold = Math.max(3, dailyAvg * 0.2); 

            Object.values(daysMap).forEach(day => {
                if(Object.keys(day.burstMap).length > 0) {
                    day.metrics.burst_peak = Math.max(...Object.values(day.burstMap));
                }
                if (activeDaysCount > 3 && day.msgs.length < lowDataThreshold) {
                    day.isLowData = true;
                }
            });

            const dailyStats = Object.values(daysMap).sort((a, b) => new Date(a.date) - new Date(b.date));

            const avgTextPerDay = activeDaysCount > 0 ? totalTextMsgs / activeDaysCount : 0;
            let validityLevel = 'low';
            if (avgTextPerDay > 40) validityLevel = 'high';
            else if (avgTextPerDay >= 15) validityLevel = 'med';

            let totalWordsValid = 0;
            let grandTotals = { self:0, cog:0, hedge:0, happyScoreSum:0, validHappyDays:0, shareScoreSum:0 };
            
            const globalStrongDensity = totalWords > 0 ? (countPosStrong / totalWords) * 100 : 0;
            const strongPosWeight = globalStrongDensity > 2.0 ? 1.2 : 2.0;

            dailyStats.forEach(curr => {
                if (!curr.isLowData) {
                    totalWordsValid += (curr.metrics.wordCount || 1);
                    grandTotals.self += curr.metrics.self;
                    grandTotals.cog += curr.metrics.cog;
                    grandTotals.hedge += curr.metrics.hedge;
                    
                    const stickerScore = Math.log2(curr.metrics.sticker + 1) * 1.5; 
                    const exclScore = Math.log2(curr.metrics.exclamations + 1) * 0.5;
                    const tildeScore = curr.metrics.tilde * 0.5;
                    const periodScore = curr.metrics.hard_period * 1.0;
                    const burstFactor = curr.metrics.burst_peak > 3 ? (curr.metrics.burst_peak * 0.2) : 0;

                    let hScore = (curr.metrics.pos_strong * strongPosWeight) 
                               + (curr.metrics.pos_normal * 1) 
                               - (curr.metrics.neg * 1.5) 
                               - (curr.metrics.dirty_pure * 2.0)
                               + stickerScore + exclScore + tildeScore - periodScore;
                    
                    if (hScore > 0) hScore += burstFactor;
                    else if (hScore < 0) hScore -= burstFactor;

                    grandTotals.happyScoreSum += hScore;
                    grandTotals.validHappyDays++;
                    curr.finalHappyScore = hScore;
                }
                grandTotals.shareScoreSum += (curr.metrics.links * 2) + (curr.metrics.media * 1.5) + (curr.metrics.sharePhrase * 1);
            });

            const safeWords = totalWordsValid > 0 ? totalWordsValid : 1;
            
            const baseline = {
                self: (grandTotals.self / safeWords) * 100,
                cog: (grandTotals.cog / safeWords) * 100,
                hedge: (grandTotals.hedge / safeWords) * 100,
                happyScore: grandTotals.validHappyDays > 0 ? grandTotals.happyScoreSum / grandTotals.validHappyDays : 0,
                shareScore: grandTotals.shareScoreSum / dailyStats.length,
                strongPosWeight: strongPosWeight
            };

            const personaCounts = {};
            dailyStats.forEach(day => {
                if (!day.isLowData) {
                    const p = getDailyPersona(day.metrics, baseline);
                    if (p.id !== 'coffee') {
                        personaCounts[p.id] = (personaCounts[p.id] || 0) + 1;
                    }
                }
            });
            
            let maxCount = 0;
            let overallPid = 'coffee';
            for (const [pid, count] of Object.entries(personaCounts)) {
                if (count > maxCount) {
                    maxCount = count;
                    overallPid = pid;
                }
            }
            const overallPersona = PERSONAS.find(p => p.id === overallPid) || PERSONAS[10];

            processedData[speaker] = {
                daily: dailyStats,
                months: [...monthSet].sort(),
                baseline: baseline,
                dailyAvg: dailyAvg,
                avgTextPerDay: avgTextPerDay,
                validity: validityLevel,
                overallPersona: overallPersona
            };
        });
        
        initUI();
    }

    var grandTotalsRef = {}; 
    function calculateOverallPersonaMode(stats, base) { return null; }

    function initUI() {
        const spkSelect = document.getElementById('speakerSelect');
        spkSelect.value = currentSpeaker; 
        
        spkSelect.addEventListener('change', (e) => {
            currentSpeaker = e.target.value;
            updateMonthSelect();
        });
        
        document.getElementById('monthSelect').addEventListener('change', (e) => {
            currentMonth = e.target.value;
            updateDashboard();
        });

        document.getElementById('controls').classList.remove('hidden');
        document.getElementById('navTabs').classList.remove('hidden');
        
        switchTab('persona'); 
        updateMonthSelect();
    }

    function switchTab(tab) {
        activeTab = tab;
        document.getElementById('tabPersona').classList.remove('active');
        document.getElementById('tabChart').classList.remove('active');
        document.getElementById('viewPersona').classList.add('hidden');
        document.getElementById('viewChart').classList.add('hidden');
        
        if(tab === 'persona') {
            document.getElementById('tabPersona').classList.add('active');
            document.getElementById('viewPersona').classList.remove('hidden');
            updateMonthSelect(); 
        } else {
            document.getElementById('tabChart').classList.add('active');
            document.getElementById('viewChart').classList.remove('hidden');
            updateMonthSelect();
            setTimeout(() => { if(mainChartInstance) mainChartInstance.resize(); }, 100);
        }
    }

    function updateMonthSelect() {
        if (!processedData[currentSpeaker]) return;
        const months = processedData[currentSpeaker].months;
        const mSelect = document.getElementById('monthSelect');
        const prevSelected = mSelect.value;
        mSelect.innerHTML = '';
        
        if(activeTab === 'chart') {
            const allOpt = document.createElement('option');
            allOpt.value = 'ALL';
            allOpt.text = 'ğŸ“… ç¶œè§€å…¨éƒ¨ç´€éŒ„';
            mSelect.appendChild(allOpt);
        }

        months.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m;
            opt.text = m;
            mSelect.appendChild(opt);
        });
        
        let targetMonth = prevSelected;
        if (targetMonth === 'ALL' && activeTab === 'persona') targetMonth = ''; 
        
        const options = Array.from(mSelect.options).map(o => o.value);
        if (!options.includes(targetMonth)) {
            if(months.length > 1) targetMonth = months[months.length - 2];
            else if (months.length > 0) targetMonth = months[months.length - 1];
            else if(activeTab === 'chart') targetMonth = 'ALL';
        }
        
        currentMonth = targetMonth;
        mSelect.value = currentMonth;
        updateDashboard();
    }

    function updateDashboard() {
        const warningEl = document.getElementById('monthStatus');
        
        if (currentMonth !== 'ALL' && currentMonth === latestMonthInFile) {
            warningEl.classList.remove('hidden');
        } else {
            warningEl.classList.add('hidden');
        }

        const data = processedData[currentSpeaker];
        if (!data) return;

        renderValidity(data);
        renderOverallPersona(data.overallPersona);

        const baseline = data.baseline;
        let activeDays = [];

        if (currentMonth === 'ALL') {
            if (data.daily.length > 0) {
                const first = new Date(data.daily[0].date);
                const last = new Date(data.daily[data.daily.length - 1].date);
                activeDays = fillMissingDays(data.daily, first, last);
            }
        } else {
            if (!currentMonth) return;
            const parts = currentMonth.split('/');
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]);
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            activeDays = fillMissingDays(data.daily.filter(d => d.month === currentMonth), firstDay, lastDay);
        }
        
        renderDailyLandscape(activeDays, baseline);

        if (activeDays.length === 0) return;

        let totalWordsInterval = 0;
        let intTotals = { self:0, cog:0, hedge:0, happyScoreSum:0, validHappyDays:0, shareScoreSum:0 };

        activeDays.forEach(curr => {
            if (!curr.isLowData) {
                totalWordsInterval += (curr.metrics.wordCount || 1);
                intTotals.self += curr.metrics.self;
                intTotals.cog += curr.metrics.cog;
                intTotals.hedge += curr.metrics.hedge;
                intTotals.happyScoreSum += (curr.finalHappyScore || 0);
                intTotals.validHappyDays++;
            }
            intTotals.shareScoreSum += (curr.metrics.links * 2) + (curr.metrics.media * 1.5) + (curr.metrics.sharePhrase * 1);
        });

        const safeIntWords = totalWordsInterval > 0 ? totalWordsInterval : 1;
        const totalDivisor = activeDays.length > 0 ? activeDays.length : 1;
        const validHappyDivisor = intTotals.validHappyDays > 0 ? intTotals.validHappyDays : 1;

        const avg = {
            self: (intTotals.self / safeIntWords) * 100,
            cog: (intTotals.cog / safeIntWords) * 100,
            hedge: (intTotals.hedge / safeIntWords) * 100,
            happyScore: intTotals.happyScoreSum / validHappyDivisor,
            shareScore: intTotals.shareScoreSum / totalDivisor
        };

        renderCard('statSelf', 'trendSelf', avg.self, baseline.self, 1);
        renderCard('statCog', 'trendCog', avg.cog, baseline.cog, 1);
        renderCard('statHedge', 'trendHedge', avg.hedge, baseline.hedge, 1);
        renderCard('statHappy', 'trendHappy', avg.happyScore, baseline.happyScore, 1);
        renderCard('statShare', 'trendShare', avg.shareScore, baseline.shareScore, 1);

        calculateAllPersonas(avg, baseline);
        generateInsight(avg, baseline, intTotals.validHappyDays, activeDays.length);
        renderChart(activeDays, baseline);
    }
    
    function renderValidity(data) {
        const banner = document.getElementById('validityBanner');
        banner.classList.remove('hidden', 'validity-high', 'validity-med', 'validity-low');
        
        let msg = "";
        let colorClass = "";
        const avg = data.avgTextPerDay.toFixed(1);

        if (data.validity === 'high') {
            colorClass = 'validity-high';
            msg = `ğŸŸ¢ ä¾æ“šäººéš›æºé€šç†è«–ï¼Œæ­·å²æ—¥å‡æ–‡å­—é‡ ${avg} å‰‡ (é«˜æ–¼40)ï¼Œé€™ä»½çµ±è¨ˆçš„å¯ä¿¡åº¦æ¥µé«˜ã€‚`;
        } else if (data.validity === 'med') {
            colorClass = 'validity-med';
            msg = `ğŸŸ¡ æ­·å²æ—¥å‡æ–‡å­—é‡ ${avg} å‰‡ (15-40ä¹‹é–“)ï¼Œçµ±è¨ˆå…·åƒè€ƒåƒ¹å€¼ã€‚`;
        } else {
            colorClass = 'validity-low';
            msg = `ğŸ”´ æ­·å²æ—¥å‡æ–‡å­—é‡åƒ… ${avg} å‰‡ (ä½æ–¼15)ï¼Œå¯èƒ½å¤šç‚ºè¦‹é¢æˆ–é€šè©±ï¼Œçµ±è¨ˆå¯ä¿¡åº¦è¼ƒä½ã€‚`;
        }
        
        banner.innerText = msg;
        banner.classList.add(colorClass);
        banner.classList.remove('hidden');
    }

    function renderOverallPersona(persona) {
        document.getElementById('histIcon').innerText = persona.icon;
        document.getElementById('histTitle').innerText = persona.name;
        document.getElementById('histDesc').innerText = `æ ¹æ“šæ•´é«”å°è©±ï¼Œ${currentSpeaker} åœ¨é€™æ®µé—œä¿‚ä¸­æ¯”è¼ƒåå‘ ${persona.name} (${persona.desc})ã€‚`;
        document.querySelector('.overall-card').style.background = persona.color;
    }
    
    function getDailyPersona(dayMetrics, baseline) {
        const dayWordCount = dayMetrics.wordCount || 1;
        const daySelf = (dayMetrics.self / dayWordCount) * 100;
        const dayCog = (dayMetrics.cog / dayWordCount) * 100;
        const dayHedge = (dayMetrics.hedge / dayWordCount) * 100;
        
        const strongWeight = baseline.strongPosWeight || 2.0;
        const stickerScore = Math.log2(dayMetrics.sticker + 1) * 1.5; 
        const exclScore = Math.log2(dayMetrics.exclamations + 1) * 0.5;
        const tildeScore = dayMetrics.tilde * 0.5;
        const periodScore = dayMetrics.hard_period * 1.0;
        const burstFactor = dayMetrics.burst_peak > 3 ? (dayMetrics.burst_peak * 0.2) : 0;

        let dayHappy = (dayMetrics.pos_strong * strongWeight) 
                     + (dayMetrics.pos_normal * 1) 
                     - (dayMetrics.neg * 1.5) 
                     - (dayMetrics.dirty_pure * 2.0)
                     + stickerScore + exclScore + tildeScore - periodScore;
        
        if (dayHappy > 0) dayHappy += burstFactor;
        else if (dayHappy < 0) dayHappy -= burstFactor;

        const dayShare = dayMetrics.links * 2 + dayMetrics.media * 1.5 + dayMetrics.sharePhrase;

        const dSelf = getDev(daySelf, baseline.self);
        const dCog = getDev(dayCog, baseline.cog);
        const dHedge = getDev(dayHedge, baseline.hedge);
        const dHappy = getDev(dayHappy, baseline.happyScore);
        const dShare = getDev(dayShare, baseline.shareScore);

        let scores = PERSONAS.map(p => {
            let score = 5; 
            switch(p.id) {
                case 'hedgehog': score += (-dSelf * 0.1) + (dCog * 0.1); break;
                case 'koala': score += (dSelf * 0.1) + (dCog * 0.1) + (dHedge * 0.1); break;
                case 'actor': score += (dShare * 0.1) + (dSelf * 0.1) + (-dHappy * 0.1); break;
                case 'prof': score += (dCog * 0.1) + (-dHedge * 0.1) + (-dSelf * 0.1); break;
                case 'peacock': score += (dSelf * 0.1) + (-dHedge * 0.1) + (-dCog * 0.1); break;
                case 'volcano': score += (dSelf * 0.1) + (-dHappy * 0.1) + (-dCog * 0.1); break;
                case 'owl': score += (-dSelf * 0.1) + (dCog * 0.1) + (dHedge * 0.1); break;
                case 'sunflower': score += (-dSelf * 0.1) + (dHappy * 0.1) + (dShare * 0.1); break;
                case 'robot': score += (-dSelf * 0.1) + (-dShare * 0.1) + (-dCog * 0.1); break;
                case 'soulmate': score += (dHappy * 0.1) + (-dCog * 0.1) + (-dHedge * 0.1); break;
                case 'coffee': 
                    const stability = 50 - (Math.abs(dSelf) + Math.abs(dCog) + Math.abs(dHedge) + Math.abs(dHappy) + Math.abs(dShare))/5;
                    score += Math.max(0, stability);
                    break;
            }
            return { ...p, score: Math.max(0, score) }; 
        });

        scores.sort((a, b) => b.score - a.score);
        return scores[0];
    }
    
    function renderDailyLandscape(days, baseline) {
        const container = document.getElementById('dailyPersonaContainer');
        container.innerHTML = '';
        
        days.forEach(day => {
            const div = document.createElement('div');
            div.className = 'daily-item';
            
            const dateLabel = document.createElement('div');
            dateLabel.className = 'daily-date';
            dateLabel.innerText = day.date.split('/').slice(1).join('/'); 
            
            const iconLabel = document.createElement('div');
            iconLabel.className = 'daily-emoji';
            
            if (day.isLowData) {
                iconLabel.innerText = 'ğŸ’¤';
                div.style.backgroundColor = '#f1f5f9'; 
                div.title = `${day.date} è¦‹é¢/å¿™ç¢Œæ—¥ (ä½æ•¸æ“š)`;
            } else {
                const persona = getDailyPersona(day.metrics, baseline);
                iconLabel.innerText = persona.icon;
                div.style.backgroundColor = persona.bg;
                div.style.borderColor = persona.color;
                div.title = `${day.date} ${persona.name}`;
            }
            
            div.appendChild(dateLabel);
            div.appendChild(iconLabel);
            container.appendChild(div);
        });
    }

    function fillMissingDays(existingDays, startDate, endDate) {
        const filled = [];
        const existingMap = {};
        existingDays.forEach(d => existingMap[d.date] = d);

        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const dateStr = `${y}/${m}/${day}`;
            
            if (existingMap[dateStr]) {
                filled.push(existingMap[dateStr]);
            } else {
                filled.push({
                    date: dateStr,
                    month: `${y}/${m}`,
                    msgs: [],
                    metrics: { 
                        wordCount: 0, self: 0, cog: 0, hedge: 0, 
                        sticker: 0, links: 0, media: 0, sharePhrase: 0,
                        pos_strong: 0, pos_normal: 0, neg: 0, exclamations: 0,
                        dirty_pure: 0, tilde: 0, hard_period: 0, burst_peak: 0 
                    },
                    isLowData: true
                });
            }
        }
        return filled;
    }

    function getDev(cur, base) {
        if(base === 0) return 0;
        return ((cur - base) / base) * 100;
    }

    function calculateAllPersonas(cur, base) {
        const dSelf = getDev(cur.self, base.self);
        const dCog = getDev(cur.cog, base.cog);
        const dHedge = getDev(cur.hedge, base.hedge);
        const dHappy = getDev(cur.happyScore, base.happyScore);
        const dShare = getDev(cur.shareScore, base.shareScore);

        let scores = PERSONAS.map(p => {
            let score = 5; 
            switch(p.id) {
                case 'hedgehog': score += (-dSelf * 0.1) + (dCog * 0.1); break;
                case 'koala': score += (dSelf * 0.1) + (dCog * 0.1) + (dHedge * 0.1); break;
                case 'actor': score += (dShare * 0.1) + (dSelf * 0.1) + (-dHappy * 0.1); break;
                case 'prof': score += (dCog * 0.1) + (-dHedge * 0.1) + (-dSelf * 0.1); break;
                case 'peacock': score += (dSelf * 0.1) + (-dHedge * 0.1) + (-dCog * 0.1); break;
                case 'volcano': score += (dSelf * 0.1) + (-dHappy * 0.1) + (-dCog * 0.1); break;
                case 'owl': score += (-dSelf * 0.1) + (dCog * 0.1) + (dHedge * 0.1); break;
                case 'sunflower': score += (-dSelf * 0.1) + (dHappy * 0.1) + (dShare * 0.1); break;
                case 'robot': score += (-dSelf * 0.1) + (-dShare * 0.1) + (-dCog * 0.1); break;
                case 'soulmate': score += (dHappy * 0.1) + (-dCog * 0.1) + (-dHedge * 0.1); break;
                case 'coffee': 
                    const stability = 50 - (Math.abs(dSelf) + Math.abs(dCog) + Math.abs(dHedge) + Math.abs(dHappy) + Math.abs(dShare))/5;
                    score += Math.max(0, stability);
                    break;
            }
            return { ...p, score: Math.max(0, score) }; 
        });

        const totalScore = scores.reduce((sum, item) => sum + item.score, 0);
        scores = scores.map(p => ({ ...p, percent: totalScore > 0 ? (p.score / totalScore) * 100 : 0 }));
        scores = scores.sort((a, b) => b.percent - a.percent);

        const top3 = scores.slice(0, 3);
        const main = top3[0];
        
        document.getElementById('personaTitle').innerText = `${main.name} (${main.percent.toFixed(0)}%)`;
        
        const iconContainer = document.getElementById('personaIcons');
        iconContainer.innerHTML = '';
        top3.forEach((p, idx) => {
             const span = document.createElement('span');
             span.innerText = p.icon;
             span.className = idx === 0 ? "persona-icon-main" : "persona-icon-sub";
             iconContainer.appendChild(span);
        });

        // Updated: Natural Language "ä»–é€™å€‹æœˆæ¯”è¼ƒ..."
        let descText = `ä»–é€™å€‹æœˆæ¯”è¼ƒ <span class="font-bold">${main.desc}</span>ã€‚`;
        if (top3[1].percent > 15) descText += `åŒæ™‚ä¹Ÿé¡¯å¾—æœ‰é» <span class="font-bold">${top3[1].desc}</span>ï¼Œ`;
        if (top3[2].percent > 10) descText += `å¶çˆ¾æœƒ <span class="font-bold">${top3[2].desc}</span>ã€‚`;
        
        document.getElementById('personaDesc').innerHTML = descText;
        document.getElementById('personaTag').innerText = `ä¸»å°è§’è‰²ä½”æ¯” ${main.percent.toFixed(1)}%`;
        document.querySelector('.persona-card').style.background = main.color;
        
        document.getElementById('personaScore').classList.remove('hidden');
        document.getElementById('scoreVal').innerText = main.percent.toFixed(0);

        const specContainer = document.getElementById('spectrumList');
        specContainer.innerHTML = '';
        scores.forEach(s => {
            const div = document.createElement('div');
            div.className = 'spectrum-item';
            div.innerHTML = `<div class="spec-icon">${s.icon}</div><div class="spec-name">${s.name}</div><div class="spec-bar-container"><div class="spec-bar-bg"><div class="spec-bar-fill" style="width:${s.percent}%; background:${s.color}"></div></div></div><div class="spec-val">${s.percent.toFixed(1)}%</div>`;
            specContainer.appendChild(div);
        });
    }

    function renderCard(valId, trendId, current, base, decimals) {
        document.getElementById(valId).innerText = current.toFixed(decimals);
        const elTrend = document.getElementById(trendId);
        const diff = current - base;
        const pct = base > 0 ? (diff / base) * 100 : 0;
        if (diff > 0.01) { elTrend.innerText = `â†‘${Math.abs(pct).toFixed(0)}%`; elTrend.className = "stat-trend bg-red-100 text-red-600"; }
        else if (diff < -0.01) { elTrend.innerText = `â†“${Math.abs(pct).toFixed(0)}%`; elTrend.className = "stat-trend bg-green-100 text-green-600"; }
        else { elTrend.innerText = "-"; elTrend.className = "stat-trend bg-slate-100 text-slate-500"; }
    }

    // Natural Language Insight Generation (v5.0 Update: "ä»–é€™å€‹æœˆæ¯”è¼ƒ...")
    function generateInsight(cur, base, validDays, totalDays) { 
        const sentences = [];
        
        // 1. Happy
        if (cur.happyScore < base.happyScore * 0.6) {
            sentences.push(`ä»–é€™å€‹æœˆæ¯”è¼ƒ <span class="font-bold text-slate-600">ç–²ç´¯æˆ–å¿™ç¢Œ</span>ï¼Œæ•´é«”å¿«æ¨‚æŒ‡æ•¸åä½ã€‚`);
        } else if (cur.happyScore > base.happyScore * 1.2) {
            sentences.push(`ä»–é€™å€‹æœˆæ¯”è¼ƒ <span class="font-bold text-pink-600">æ­£å‘ç©æ¥µ</span>ï¼Œå……æ»¿èƒ½é‡ï¼`);
        }

        // 2. Self & Cog
        if (cur.self < base.self * 0.8 && cur.cog > base.cog * 1.2) {
            sentences.push(`ä»–é€™å€‹æœˆæ¯”è¼ƒ <span class="font-bold text-orange-600">æ•æ„Ÿé˜²è¡›</span>ï¼Œå¯èƒ½æœƒç”¨é‚è¼¯ä¾†ä¿è­·è‡ªå·±ã€‚`);
        } else if (cur.self > base.self * 1.2) {
            sentences.push(`ä»–é€™å€‹æœˆæ¯”è¼ƒ <span class="font-bold text-blue-600">è‡ªæˆ‘ä¸­å¿ƒ</span>ï¼Œç†±è¡·åˆ†äº«è‡ªå·±çš„æƒ³æ³•ã€‚`);
        }

        // 3. Hedge
        if (cur.cog > base.cog * 1.2 && cur.hedge > base.hedge * 1.2) {
            sentences.push(`ä»–é€™å€‹æœˆæ¯”è¼ƒ <span class="font-bold text-purple-600">çŒ¶è±«ä¸æ±º</span>ï¼Œèªæ°£å……æ»¿ä¸ç¢ºå®šæ€§ã€‚`);
        }

        // Fallback
        if(sentences.length === 0) {
             sentences.push(`ä»–é€™å€‹æœˆæ¯”è¼ƒ <span class="font-bold text-indigo-600">å¹³ç©©å®‰å®š</span>ï¼Œæ²’æœ‰å¤ªå¤§çš„æƒ…ç·’èµ·ä¼ï¼Œç›¸è™•èµ·ä¾†æ‡‰è©²è »èˆ’æœçš„ã€‚`);
        }

        const displayTitle = currentMonth === 'ALL' ? 'å…¨æœŸç¶œè§€' : currentMonth;
        document.getElementById('monthSummary').innerHTML = `<strong>${displayTitle}ï¼š</strong> ` + sentences.join("<br>");
    }

    function renderChart(days, baseline) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        const labels = days.map(d => d.date.split('/').slice(1).join('/')); 
        const dShare = days.map(d => (d.metrics.links * 2) + (d.metrics.media * 1.5) + (d.metrics.sharePhrase * 1));
        const dHappy = days.map(d => {
            if (d.isLowData) return null;
            return d.finalHappyScore || 0;
        });

        const dSelf = days.map(d => d.isLowData ? null : (d.metrics.self / (d.metrics.wordCount||1) * 100));
        const dCog = days.map(d => d.isLowData ? null : (d.metrics.cog / (d.metrics.wordCount||1) * 100));
        const dHedge = days.map(d => d.isLowData ? null : (d.metrics.hedge / (d.metrics.wordCount||1) * 100));
        const dOffline = days.map(d => d.isLowData ? 2 : 0);

        if (mainChartInstance) mainChartInstance.destroy();

        mainChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { type: 'line', label: 'ç¶œåˆåˆ†äº«æ…¾', data: dShare, borderColor: '#06b6d4', backgroundColor: 'rgba(6, 182, 212, 0.1)', borderWidth: 2, tension: 0.3, yAxisID: 'y' },
                    { type: 'line', label: 'è‡ªæˆ‘æ“æŠ±åº¦ (%)', data: dSelf, borderColor: '#3b82f6', borderDash: [5, 5], borderWidth: 1.5, tension: 0.3, hidden: true, yAxisID: 'y1' },
                    { type: 'line', label: 'èªçŸ¥éè¼‰ (%)', data: dCog, borderColor: '#f97316', borderDash: [5, 5], borderWidth: 1.5, tension: 0.3, hidden: true, yAxisID: 'y1' },
                    { type: 'line', label: 'èªæ°£çŒ¶è±«åº¦ (%)', data: dHedge, borderColor: '#a855f7', borderDash: [5, 5], borderWidth: 1.5, tension: 0.3, hidden: true, yAxisID: 'y1' },
                    { type: 'bar', label: 'å¿«æ¨‚æŒ‡æ•¸', data: dHappy, backgroundColor: (ctx) => ctx.raw >= 0 ? 'rgba(34, 197, 94, 0.6)' : 'rgba(239, 68, 68, 0.6)', yAxisID: 'y' },
                    { type: 'bar', label: 'è¦‹é¢/ä½å°è©±', data: dOffline, backgroundColor: '#cbd5e1', yAxisID: 'y', barPercentage: 0.8 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                scales: { 
                    y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'æŒ‡æ•¸ / æ¬¡æ•¸' } }, 
                    y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'èªè¨€ä½”æ¯” (%)' } }
                },
                plugins: { legend: { position: 'top', labels: { boxWidth: 12, usePointStyle: true } } },
                onClick: (e, els) => { if(els.length > 0) showDetails(days[els[0].index]); }
            }
        });
        if(days.length > 0) showDetails(days[days.length-1]);
    }

    function showDetails(day) {
        const list = document.getElementById('detailList');
        document.getElementById('detailDate').innerText = `${day.date}`;
        if (day.isLowData) {
            document.getElementById('detailStats').innerText = `è¨Šæ¯æ•¸: ${day.msgs.length}`;
            document.getElementById('detailMood').innerText = "ğŸ’¤ è¦‹é¢/ä½æ•¸æ“š";
            document.getElementById('detailMood').className = "text-[10px] px-2 py-1 rounded-full bg-slate-300 text-slate-700";
        } else {
            const hScore = day.finalHappyScore ? day.finalHappyScore.toFixed(1) : "0.0";
            document.getElementById('detailStats').innerText = `å¿«æ¨‚åˆ†: ${hScore}`;
            let mood = "æ—¥å¸¸"; let mClass = "bg-slate-200 text-slate-500";
            if (hScore > 8) { mood = "ğŸ¤© æƒ…ç·’é«˜æ˜‚"; mClass = "bg-green-100 text-green-700"; }
            else if (hScore < -2) { mood = "ğŸŒ§ï¸ ç–²ç´¯/ä½èƒ½é‡"; mClass = "bg-red-100 text-red-700"; }
            else if ((day.metrics.links + day.metrics.media) > 3) { mood = "ğŸ”— ç‹‚ç†±åˆ†äº«"; mClass = "bg-cyan-100 text-cyan-700"; }
            const badge = document.getElementById('detailMood'); badge.innerText = mood; badge.className = `text-[10px] px-2 py-1 rounded-full ${mClass}`;
        }
        list.innerHTML = '';
        if(day.msgs.length === 0) { list.innerHTML = '<div class="text-center text-slate-400 mt-10">ï¼ˆæœ¬æ—¥ç„¡å°è©±ç´€éŒ„ï¼Œå¯èƒ½ç‚ºè¦‹é¢æ—¥ï¼‰</div>'; return; }
        day.msgs.forEach(msg => {
            const div = document.createElement('div'); div.className = 'message-row';
            if (day.isLowData) div.classList.add('low-data-day');
            let html = msg.content;
            if (msg.isSticker) html = `<span class="highlight-sticker">LINE è²¼åœ–</span>`;
            else if (msg.isImage) html = `<span class="highlight-share font-bold">[åœ–ç‰‡/å½±ç‰‡]</span>`;
            else {
                const urlRegex = /(https?:\/\/[^\s]+)/g; html = html.replace(urlRegex, '<span class="highlight-share">é€£çµ</span>');
                // Use safe iteration for dictionary terms
                const safeDict = (key) => DICT[key] || [];
                safeDict('share_phrases').forEach(w => html = html.replaceAll(w, `<span class="highlight-share">${w}</span>`));
                safeDict('pos_strong').forEach(w => html = html.replaceAll(w, `<span class="highlight-pos">${w}</span>`));
                safeDict('neg').forEach(w => html = html.replaceAll(w, `<span class="highlight-neg">${w}</span>`));
                let isDirty = false;
                safeDict('dirty').forEach(w => { if (html.includes(w)) isDirty = true; html = html.replaceAll(w, `<span class="highlight-dirty">${w}</span>`) });
                
                // Tilde Highlight
                html = html.replace(/([~ï½ã€œ])/g, '<span class="highlight-tilde">$1</span>');
                html = html.replace(/ï¼|!/g, '<span class="text-red-500 font-bold">!</span>');
            }
            div.innerHTML = `<div class="message-time">${msg.time}</div><div class="message-content text-slate-700">${html}</div>`; list.appendChild(div);
        });
    }

    function toggleModal(id) {
        const el = document.getElementById(id);
        if(el.classList.contains('hidden')) { el.classList.remove('hidden'); setTimeout(() => el.querySelector('div').classList.remove('scale-95', 'opacity-0'), 10); } 
        else { el.querySelector('div').classList.add('scale-95', 'opacity-0'); setTimeout(() => el.classList.add('hidden'), 200); }
    }
</script>
</body>
</html>
